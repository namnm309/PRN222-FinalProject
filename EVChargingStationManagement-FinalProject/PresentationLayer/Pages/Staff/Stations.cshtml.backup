@page
@model PresentationLayer.Pages.Staff.StationsModel
@{
    Layout = "~/Pages/Shared/_DashboardLayout.cshtml";
    ViewData["Title"] = "Staff ‚Ä¢ Theo d√µi tr·∫°m s·∫°c";
}

<link rel="stylesheet" href="/css/staff-common.css">
<link rel="stylesheet" href="/css/realtime-monitor.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
<script src="/js/station-monitoring.js"></script>

<style>
    .station-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .station-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #E5E7EB;
        transition: all 0.2s;
        cursor: pointer;
    }

    .station-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .station-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .station-name {
        font-size: 18px;
        font-weight: 600;
        color: #101828;
        margin: 0 0 4px 0;
    }

    .station-address {
        font-size: 13px;
        color: #6B7280;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .station-status-badge {
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .station-status-badge.active {
        background: #D1FAE5;
        color: #065F46;
    }

    .station-status-badge.inactive {
        background: #F3F4F6;
        color: #6B7280;
    }

    .station-status-badge.maintenance {
        background: #FED7AA;
        color: #92400E;
    }

    .spots-summary {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin: 16px 0;
    }

    .spot-stat {
        background: #F9FAFB;
        padding: 12px;
        border-radius: 8px;
        text-align: center;
    }

    .spot-stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #101828;
        margin-bottom: 4px;
    }

    .spot-stat-label {
        font-size: 12px;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .spot-stat.available .spot-stat-value {
        color: #10B981;
    }

    .spot-stat.occupied .spot-stat-value {
        color: #3B82F6;
    }

    .spot-stat.maintenance .spot-stat-value {
        color: #F59E0B;
    }

    .spot-stat.offline .spot-stat-value {
        color: #EF4444;
    }

    .station-spots-list {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #E5E7EB;
    }

    .spots-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
    }

    .spots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 8px;
    }

    .spot-item {
        padding: 8px;
        border-radius: 8px;
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .spot-item:hover {
        transform: scale(1.05);
    }

    .spot-item.available {
        background: #D1FAE5;
        color: #065F46;
    }

    .spot-item.occupied {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .spot-item.maintenance {
        background: #FED7AA;
        color: #92400E;
    }

    .spot-item.outofservice {
        background: #FEE2E2;
        color: #991B1B;
    }

    .station-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 13px;
        flex: 1;
    }

    .view-toggle {
        display: flex;
        gap: 8px;
        background: white;
        padding: 4px;
        border-radius: 8px;
        border: 1px solid #E5E7EB;
    }

    .toggle-btn {
        padding: 8px 16px;
        border: none;
        background: transparent;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        color: #6B7280;
        cursor: pointer;
        transition: all 0.2s;
    }

    .toggle-btn.active {
        background: #00A63E;
        color: white;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #101828;
    }

    .close-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: none;
        background: #F3F4F6;
        cursor: pointer;
        font-size: 18px;
        color: #6B7280;
    }

    .close-btn:hover {
        background: #E5E7EB;
    }

    .modal-body {
        padding: 20px;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #F3F4F6;
    }

    .detail-label {
        font-size: 14px;
        color: #6B7280;
    }

    .detail-value {
        font-size: 14px;
        font-weight: 600;
        color: #101828;
    }

    @@media (max-width: 768px) {
        .station-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="page-container">
    <section class="page-header">
        <div class="page-title">
            <h2>Theo d√µi tr·∫°m s·∫°c</h2>
            <p class="page-subtitle">Gi√°m s√°t tr·∫°ng th√°i ƒëi·ªÉm s·∫°c v√† ho·∫°t ƒë·ªông tr·∫°m</p>
        </div>
    </section>

    <!-- Filters Section -->
    <section class="filters-section">
        <div class="filter-group">
            <label>Tr·∫°m s·∫°c</label>
            <select id="stationFilter" class="filter-select">
                <option value="">T·∫•t c·∫£ tr·∫°m</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Kho·∫£ng th·ªùi gian</label>
            <select id="timeFilter" class="filter-select">
                <option value="today">H√¥m nay</option>
                <option value="week">Tu·∫ßn n√†y</option>
                <option value="month">Th√°ng n√†y</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="applyFilters()">
            üîç √Åp d·ª•ng
        </button>
        <button class="btn btn-outline" onclick="location.reload()">
            üîÑ L√†m m·ªõi
        </button>
    </section>

    <!-- Stats Row -->
    <section class="stats-row">
        <div class="stat-card">
            <div class="stat-icon green">‚úÖ</div>
            <div class="stat-label">ƒêi·ªÉm s·∫°c kh·∫£ d·ª•ng</div>
            <div class="stat-value" id="statAvailable">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon blue">‚ö°</div>
            <div class="stat-label">ƒêang s·ª≠ d·ª•ng</div>
            <div class="stat-value" id="statOccupied">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange">üîß</div>
            <div class="stat-label">B·∫£o tr√¨</div>
            <div class="stat-value" id="statMaintenance">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon red">‚ùå</div>
            <div class="stat-label">Kh√¥ng ho·∫°t ƒë·ªông</div>
            <div class="stat-value" id="statOffline">0</div>
        </div>
    </section>

    <!-- Filter Section -->
    <section class="filter-section">
        <div class="filter-grid">
            <div class="filter-group">
                <label>Tr·∫°ng th√°i tr·∫°m</label>
                <select id="filterStationStatus" onchange="applyFilters()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="0">Ho·∫°t ƒë·ªông</option>
                    <option value="1">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    <option value="2">B·∫£o tr√¨</option>
                </select>
            </div>
            <div class="filter-group">
                <label>T√¨m ki·∫øm</label>
                <input type="text" id="searchInput" placeholder="T√¨m theo t√™n tr·∫°m..." onkeyup="searchStations()">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn btn-outline" onclick="clearFilters()">X√≥a b·ªô l·ªçc</button>
        </div>
    </section>

    <!-- Stations Grid/List -->
    <section id="stationsContainer">
        <div class="empty-state">
            <div class="empty-icon">üìç</div>
            <div class="empty-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
    </section>
</div>

<!-- Station Detail Modal -->
<div id="stationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Chi ti·∫øt tr·∫°m s·∫°c</h3>
            <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Dynamic content -->
        </div>
    </div>
</div>

<script>
let allStations = [];
let filteredStations = [];
let currentView = 'grid';

document.addEventListener('DOMContentLoaded', function() {
    loadStations();
    updateStats();
    
    // Setup SignalR event handlers
    setupRealtimeMonitoring();
    
    // Fallback: Still refresh periodically (less frequently since we have real-time updates)
    setInterval(() => {
        if (!window.stationMonitor || !window.stationMonitor.isConnected) {
            loadStations();
            updateStats();
        }
    }, 60000); // Every minute instead of 30 seconds
});

function setupRealtimeMonitoring() {
    // Wait for stationMonitor to be ready
    const checkMonitor = setInterval(() => {
        if (window.stationMonitor && window.stationMonitor.isConnected) {
            clearInterval(checkMonitor);
            
            // Register event handlers
            window.stationMonitor.on('spotStatusChanged', (data) => {
                console.log('Spot status changed:', data);
                // Reload stations to reflect changes
                loadStations();
                updateStats();
            });
            
            window.stationMonitor.on('stationStatusChanged', (data) => {
                console.log('Station status changed:', data);
                loadStations();
            });
            
            window.stationMonitor.on('statsUpdated', (data) => {
                console.log('Stats updated:', data);
                // Stats are auto-updated by the monitoring service
            });
            
            window.stationMonitor.on('sessionStarted', (data) => {
                console.log('Session started:', data);
                loadStations();
                updateStats();
            });
            
            window.stationMonitor.on('sessionEnded', (data) => {
                console.log('Session ended:', data);
                loadStations();
                updateStats();
            });
            
            window.stationMonitor.on('errorReported', (data) => {
                console.log('Error reported:', data);
                // Refresh to show new error
                loadStations();
            });
            
            window.stationMonitor.on('maintenanceScheduled', (data) => {
                console.log('Maintenance scheduled:', data);
                loadStations();
            });
        }
    }, 500);
    
    // Give up after 10 seconds
    setTimeout(() => clearInterval(checkMonitor), 10000);
}

async function loadStations() {
    try {
        // Use SerpApi to get real charging stations from Google Maps
        const response = await fetch('/api/Maps/charging-stations');
        if (!response.ok) throw new Error('Failed to fetch stations');
        
        const data = await response.json();
        console.log('[Stations] Loaded from:', data.source, '- Count:', data.count);
        
        allStations = data.stations || [];
        filteredStations = [...allStations];
        applyFilters();
    } catch (error) {
        console.error('Error loading stations:', error);
        showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Maps');
    }
}

async function updateStats() {
    try {
        let totalAvailable = 0, totalOccupied = 0, totalMaintenance = 0, totalOffline = 0;
        
        // Calculate stats from loaded stations (from SerpApi)
        for (const station of allStations) {
            if (station.chargingSpots && Array.isArray(station.chargingSpots)) {
                const spots = station.chargingSpots;
                totalAvailable += spots.filter(s => s.status === 0).length;
                totalOccupied += spots.filter(s => s.status === 1).length;
                totalMaintenance += spots.filter(s => s.status === 2).length;
                totalOffline += spots.filter(s => s.status === 3).length;
            }
        }
        
        document.getElementById('statAvailable').textContent = totalAvailable;
        document.getElementById('statOccupied').textContent = totalOccupied;
        document.getElementById('statMaintenance').textContent = totalMaintenance;
        document.getElementById('statOffline').textContent = totalOffline;
        
        console.log('[Stats] Available:', totalAvailable, 'Occupied:', totalOccupied, 
                    'Maintenance:', totalMaintenance, 'Offline:', totalOffline);
    } catch (error) {
        console.error('Error updating stats:', error);
    }
}

function applyFilters() {
    let filtered = [...allStations];
    
    const statusFilter = document.getElementById('filterStationStatus').value;
    if (statusFilter !== '') {
        filtered = filtered.filter(s => s.status == statusFilter);
    }
    
    filteredStations = filtered;
    renderStations();
}

function clearFilters() {
    document.getElementById('filterStationStatus').value = '';
    document.getElementById('searchInput').value = '';
    applyFilters();
}

function searchStations() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    
    if (!term) {
        applyFilters();
        return;
    }
    
    filteredStations = allStations.filter(s =>
        s.name.toLowerCase().includes(term) ||
        (s.address && s.address.toLowerCase().includes(term)) ||
        (s.city && s.city.toLowerCase().includes(term))
    );
    
    renderStations();
}

async function renderStations() {
    const container = document.getElementById('stationsContainer');
    
    if (filteredStations.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üîç</div>
                <div class="empty-text">Kh√¥ng t√¨m th·∫•y tr·∫°m s·∫°c n√†o</div>
                <div class="empty-subtext">Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc</div>
            </div>
        `;
        return;
    }
    
    if (currentView === 'grid') {
        await renderGrid(container);
    } else {
        await renderList(container);
    }
}

async function renderGrid(container) {
    let html = '<div class="station-grid">';
    
    for (const station of filteredStations) {
        // Use spots from station data (already included from SerpApi)
        const spots = station.chargingSpots || [];
        
        const available = spots.filter(s => s.status === 0).length;
        const occupied = spots.filter(s => s.status === 1).length;
        const maintenance = spots.filter(s => s.status === 2).length;
        const offline = spots.filter(s => s.status === 3).length;
        
        const statusClass = getStationStatusClass(station.status);
        const statusText = getStationStatusText(station.status);
        
        // Show rating if available
        const ratingHtml = station.rating ? `
            <div style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: #F59E0B; margin-top: 4px;">
                ‚≠ê ${station.rating} ${station.reviews ? `(${station.reviews})` : ''}
            </div>
        ` : '';
        
        html += `
            <div class="station-card" onclick="showStationDetail('${station.id}')" data-station-id="${station.id}">
                <div class="station-header">
                    <div>
                        <h3 class="station-name">${station.name}</h3>
                        <div class="station-address">
                            üìç ${station.address || 'N/A'}
                        </div>
                        ${ratingHtml}
                    </div>
                    <span class="station-status-badge ${statusClass}">${statusText}</span>
                </div>
                
                <div class="spots-summary">
                    <div class="spot-stat available">
                        <div class="spot-stat-value">${available}</div>
                        <div class="spot-stat-label">S·∫µn s√†ng</div>
                    </div>
                    <div class="spot-stat occupied">
                        <div class="spot-stat-value">${occupied}</div>
                        <div class="spot-stat-label">ƒêang d√πng</div>
                    </div>
                    <div class="spot-stat maintenance">
                        <div class="spot-stat-value">${maintenance}</div>
                        <div class="spot-stat-label">B·∫£o tr√¨</div>
                    </div>
                    <div class="spot-stat offline">
                        <div class="spot-stat-value">${offline}</div>
                        <div class="spot-stat-label">Offline</div>
                    </div>
                </div>
                
                <div class="station-spots-list">
                    <div class="spots-title">ƒêi·ªÉm s·∫°c (${spots.length})</div>
                    <div class="spots-grid">
                        ${spots.map(spot => `
                            <div class="spot-item ${getSpotStatusClass(spot.status)}" 
                                 title="${spot.spotNumber} - ${spot.connectorType} ${spot.powerOutput}kW - ${getSpotStatusText(spot.status)}"
                                 data-spot-id="${spot.id}">
                                ${spot.spotNumber}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

async function renderList(container) {
    // Similar to grid but in table format
    container.innerHTML = '<div class="empty-state"><div class="empty-text">List view - Coming soon!</div></div>';
}

function setView(view) {
    currentView = view;
    
    document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
    document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
    
    renderStations();
}

async function showStationDetail(stationId) {
    const station = allStations.find(s => s.id === stationId);
    if (!station) return;
    
    const spots = station.chargingSpots || [];
    
    document.getElementById('modalTitle').textContent = station.name;
    
    const ratingHtml = station.rating ? `
        <div class="detail-row">
            <div class="detail-label">ƒê√°nh gi√°</div>
            <div class="detail-value" style="color: #F59E0B;">
                ‚≠ê ${station.rating} ${station.reviews ? `(${station.reviews} reviews)` : ''}
            </div>
        </div>
    ` : '';
    
    let modalContent = `
        <div class="detail-row">
            <div class="detail-label">ƒê·ªãa ch·ªâ</div>
            <div class="detail-value">${station.address || 'N/A'}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Th√†nh ph·ªë</div>
            <div class="detail-value">${station.city || 'N/A'}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">T·ªânh/Qu·ªëc gia</div>
            <div class="detail-value">${station.province || 'N/A'}</div>
        </div>
        ${ratingHtml}
        <div class="detail-row">
            <div class="detail-label">S·ªë ƒëi·ªán tho·∫°i</div>
            <div class="detail-value">${station.phone || 'N/A'}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Gi·ªù m·ªü c·ª≠a</div>
            <div class="detail-value">${station.hours || (station.is24Hours ? 'Open 24 hours' : 'N/A')}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">T·ªça ƒë·ªô GPS</div>
            <div class="detail-value">${station.latitude ? station.latitude.toFixed(6) : 'N/A'}, ${station.longitude ? station.longitude.toFixed(6) : 'N/A'}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">T·ªïng ƒëi·ªÉm s·∫°c</div>
            <div class="detail-value">${spots.length}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Tr·∫°ng th√°i</div>
            <div class="detail-value">
                <span class="station-status-badge ${getStationStatusClass(station.status)}">
                    ${getStationStatusText(station.status)}
                </span>
            </div>
        </div>
        
        <h4 style="margin: 20px 0 12px; font-size: 16px; font-weight: 600;">Danh s√°ch ƒëi·ªÉm s·∫°c</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
            ${spots.map(spot => `
                <div style="padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 3px solid ${getSpotStatusColor(spot.status)};">
                    <div style="font-weight: 600; margin-bottom: 4px;">${spot.spotNumber}</div>
                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 2px;">${spot.connectorType} - ${spot.powerOutput}kW</div>
                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">${spot.pricePerKwh}ƒë/kWh</div>
                    <div style="font-size: 11px;">
                        <span class="station-status-badge ${getSpotStatusClass(spot.status)}" style="font-size: 10px; padding: 2px 8px;">
                            ${getSpotStatusText(spot.status)}
                        </span>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('modalBody').innerHTML = modalContent;
    document.getElementById('stationModal').classList.add('show');
}

function getSpotStatusColor(status) {
    const colors = {
        0: '#10B981', // Available - Green
        1: '#3B82F6', // Occupied - Blue
        2: '#F59E0B', // Maintenance - Orange
        3: '#EF4444'  // Out of service - Red
    };
    return colors[status] || '#6B7280';
}

function closeModal() {
    document.getElementById('stationModal').classList.remove('show');
}

function getStationStatusClass(status) {
    return ['active', 'inactive', 'maintenance'][status] || 'active';
}

function getStationStatusText(status) {
    return ['Ho·∫°t ƒë·ªông', 'Kh√¥ng ho·∫°t ƒë·ªông', 'B·∫£o tr√¨'][status] || 'Unknown';
}

function getSpotStatusClass(status) {
    return ['available', 'occupied', 'maintenance', 'outofservice'][status] || 'available';
}

function getSpotStatusText(status) {
    return ['S·∫µn s√†ng', 'ƒêang s·ª≠ d·ª•ng', 'B·∫£o tr√¨', 'Kh√¥ng ho·∫°t ƒë·ªông'][status] || 'Unknown';
}

function showError(message) {
    document.getElementById('stationsContainer').innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">‚ùå</div>
            <div class="empty-text">ƒê√£ x·∫£y ra l·ªói</div>
            <div class="empty-subtext">${message}</div>
        </div>
    `;
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('stationModal');
    if (event.target === modal) {
        closeModal();
    }
});
</script>
