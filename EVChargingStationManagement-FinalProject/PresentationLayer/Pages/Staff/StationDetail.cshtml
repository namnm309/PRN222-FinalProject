@page "{stationId:guid?}"
@model PresentationLayer.Pages.Staff.StationDetailModel
@{
    Layout = "~/Pages/Shared/_DashboardLayout.cshtml";
    ViewData["Title"] = "Staff ‚Ä¢ Chi ti·∫øt tr·∫°m s·∫°c";
}

<link rel="stylesheet" href="/css/staff-common.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    .station-detail-page {
        padding: 24px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .station-info h2 {
        font-size: 28px;
        font-weight: 700;
        color: #101828;
        margin: 0 0 8px 0;
    }

    .station-address {
        font-size: 14px;
        color: #6B7280;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 12px;
    }

    .station-meta {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: #6B7280;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: #00A63E;
        color: white;
    }

    .btn-primary:hover {
        background: #008631;
    }

    .btn-outline {
        background: white;
        color: #374151;
        border: 1px solid #D1D5DB;
    }

    .btn-outline:hover {
        background: #F9FAFB;
    }

    .btn-danger {
        background: #EF4444;
        color: white;
    }

    .btn-danger:hover {
        background: #DC2626;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .status-active {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-inactive {
        background: #FEE2E2;
        color: #991B1B;
    }

    .status-maintenance {
        background: #FED7AA;
        color: #92400E;
    }

    /* KPIs */
    .kpis-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .kpi-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .kpi-label {
        font-size: 13px;
        color: #6B7280;
        margin-bottom: 8px;
    }

    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: #101828;
    }

    .kpi-icon {
        font-size: 24px;
        margin-bottom: 8px;
    }

    /* Content Grid */
    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    /* Spots Grid */
    .spots-section {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #101828;
        margin: 0 0 16px 0;
    }

    .spots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
    }

    .spot-card {
        background: #F9FAFB;
        padding: 16px;
        border-radius: 8px;
        border: 2px solid transparent;
        transition: all 0.2s;
        cursor: pointer;
    }

    .spot-card:hover {
        border-color: #00A63E;
        box-shadow: 0 2px 8px rgba(0, 166, 62, 0.1);
    }

    .spot-card.available {
        border-left: 4px solid #10B981;
    }

    .spot-card.occupied {
        border-left: 4px solid #3B82F6;
    }

    .spot-card.maintenance {
        border-left: 4px solid #F59E0B;
    }

    .spot-card.offline {
        border-left: 4px solid #EF4444;
    }

    .spot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .spot-number {
        font-size: 18px;
        font-weight: 700;
        color: #101828;
    }

    .spot-status {
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 600;
    }

    .spot-status.available {
        background: #D1FAE5;
        color: #065F46;
    }

    .spot-status.occupied {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .spot-status.maintenance {
        background: #FED7AA;
        color: #92400E;
    }

    .spot-status.offline {
        background: #FEE2E2;
        color: #991B1B;
    }

    .spot-info {
        font-size: 13px;
        color: #6B7280;
        line-height: 1.6;
    }

    .spot-info div {
        margin-bottom: 4px;
    }

    .spot-power {
        font-weight: 600;
        color: #00A63E;
    }

    /* Map */
    .map-section {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .map-container {
        height: 400px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #E5E7EB;
    }

    /* Recent Activity */
    .activity-section {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .activity-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        padding: 12px;
        border-left: 3px solid #E5E7EB;
        margin-bottom: 12px;
        background: #F9FAFB;
        border-radius: 4px;
    }

    .activity-item.session-start {
        border-left-color: #10B981;
    }

    .activity-item.session-end {
        border-left-color: #3B82F6;
    }

    .activity-item.error {
        border-left-color: #EF4444;
    }

    .activity-time {
        font-size: 12px;
        color: #6B7280;
        margin-bottom: 4px;
    }

    .activity-text {
        font-size: 14px;
        color: #374151;
    }

    @@media (max-width: 1200px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }

    @@media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            gap: 16px;
        }

        .spots-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="station-detail-page">
    <!-- Header -->
    <section class="page-header">
        <div class="station-info">
            <h2 id="stationName">Loading...</h2>
            <div class="station-address">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M8 2C5.24 2 3 4.24 3 7C3 10.5 8 14 8 14C8 14 13 10.5 13 7C13 4.24 10.76 2 8 2Z" stroke="currentColor" stroke-width="1.5"/>
                    <circle cx="8" cy="7" r="2" stroke="currentColor" stroke-width="1.5"/>
                </svg>
                <span id="stationAddress">...</span>
            </div>
            <div class="station-meta">
                <div class="meta-item">
                    <span>‚≠ê</span>
                    <span id="stationRating">-</span>
                </div>
                <div class="meta-item">
                    <span>üìû</span>
                    <span id="stationPhone">-</span>
                </div>
                <div class="meta-item">
                    <span>üïê</span>
                    <span id="stationHours">-</span>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <span class="status-badge status-active" id="stationStatus">
                üü¢ Ho·∫°t ƒë·ªông
            </span>
            <button class="btn btn-primary" onclick="toggleMaintenance()">
                üîß B·∫£o tr√¨
            </button>
            <button class="btn btn-outline" onclick="location.reload()">
                üîÑ L√†m m·ªõi
            </button>
        </div>
    </section>

    <!-- KPIs -->
    <section class="kpis-section">
        <div class="kpi-card">
            <div class="kpi-icon">‚ö°</div>
            <div class="kpi-label">T·ªïng c√¥ng su·∫•t</div>
            <div class="kpi-value" id="totalPower">0 kW</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üìç</div>
            <div class="kpi-label">ƒêi·ªÉm s·∫°c</div>
            <div class="kpi-value" id="totalSpots">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-label">S·∫µn s√†ng</div>
            <div class="kpi-value" id="availableSpots">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üî•</div>
            <div class="kpi-label">ƒêang s·ª≠ d·ª•ng</div>
            <div class="kpi-value" id="occupiedSpots">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-label">Doanh thu h√¥m nay</div>
            <div class="kpi-value" id="todayRevenue">0 ƒë</div>
        </div>
    </section>

    <!-- Content Grid -->
    <div class="content-grid">
        <!-- Spots -->
        <div class="spots-section">
            <h3 class="section-title">ƒêi·ªÉm s·∫°c (Charging Spots)</h3>
            <div class="spots-grid" id="spotsGrid">
                <div style="text-align: center; padding: 40px; color: #6B7280;">
                    ƒêang t·∫£i...
                </div>
            </div>
        </div>

        <!-- Map -->
        <div>
            <div class="map-section">
                <h3 class="section-title">V·ªã tr√≠</h3>
                <div id="stationMap" class="map-container"></div>
            </div>
            
            <!-- Recent Activity -->
            <div class="activity-section" style="margin-top: 24px;">
                <h3 class="section-title">Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>
                <div class="activity-list" id="activityList">
                    <div style="text-align: center; padding: 20px; color: #6B7280;">
                        Ch∆∞a c√≥ ho·∫°t ƒë·ªông
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Spot Detail Modal -->
<div id="spotModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalSpotNumber">Spot A01</h3>
            <button class="modal-close" onclick="closeSpotModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalSpotBody">
            <!-- Content loaded dynamically -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeSpotModal()">ƒê√≥ng</button>
            <button class="btn btn-primary" onclick="updateSpotStatus()">C·∫≠p nh·∫≠t tr·∫°ng th√°i</button>
        </div>
    </div>
</div>

<script>
let stationData = null;
let mapInstance = null;
let currentStationId = '@Model.StationId';

document.addEventListener('DOMContentLoaded', function() {
    if (currentStationId) {
        loadStationDetail();
    }
    initMap();
});

async function loadStationDetail() {
    try {
        // Get all stations from SerpApi
        const response = await fetch('/api/Maps/charging-stations');
        const data = await response.json();
        
        if (data.success && data.stations) {
            // For demo, use first station if no ID specified
            if (!currentStationId || currentStationId === '') {
                stationData = data.stations[0];
            } else {
                stationData = data.stations.find(s => s.id === currentStationId) || data.stations[0];
            }
            
            displayStationInfo();
            displaySpots();
            updateMap();
            loadRecentActivity();
        }
    } catch (error) {
        console.error('Error loading station:', error);
    }
}

function displayStationInfo() {
    if (!stationData) return;
    
    document.getElementById('stationName').textContent = stationData.name;
    document.getElementById('stationAddress').textContent = stationData.address || 'N/A';
    document.getElementById('stationRating').textContent = stationData.rating ? 
        `${stationData.rating} (${stationData.reviews || 0})` : 'Ch∆∞a c√≥ ƒë√°nh gi√°';
    document.getElementById('stationPhone').textContent = stationData.phone || 'N/A';
    document.getElementById('stationHours').textContent = stationData.is24Hours ? 
        'M·ªü c·ª≠a 24/7' : (stationData.hours || 'N/A');
    
    // Calculate KPIs
    const spots = stationData.chargingSpots || [];
    const totalPower = spots.reduce((sum, spot) => sum + (spot.powerOutput || 0), 0);
    const available = spots.filter(s => s.status === 0).length;
    const occupied = spots.filter(s => s.status === 1).length;
    
    document.getElementById('totalPower').textContent = totalPower + ' kW';
    document.getElementById('totalSpots').textContent = spots.length;
    document.getElementById('availableSpots').textContent = available;
    document.getElementById('occupiedSpots').textContent = occupied;
    document.getElementById('todayRevenue').textContent = '0 ƒë'; // Mock data
}

function displaySpots() {
    if (!stationData || !stationData.chargingSpots) return;
    
    const grid = document.getElementById('spotsGrid');
    const spots = stationData.chargingSpots;
    
    if (spots.length === 0) {
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #6B7280;">Kh√¥ng c√≥ ƒëi·ªÉm s·∫°c</div>';
        return;
    }
    
    const statusMap = {
        0: { class: 'available', text: 'S·∫µn s√†ng' },
        1: { class: 'occupied', text: 'ƒêang d√πng' },
        2: { class: 'maintenance', text: 'B·∫£o tr√¨' },
        3: { class: 'offline', text: 'Offline' }
    };
    
    grid.innerHTML = spots.map(spot => {
        const status = statusMap[spot.status] || statusMap[0];
        return `
            <div class="spot-card ${status.class}" onclick="showSpotDetail('${spot.id}')">
                <div class="spot-header">
                    <div class="spot-number">${spot.spotNumber}</div>
                    <div class="spot-status ${status.class}">${status.text}</div>
                </div>
                <div class="spot-info">
                    <div><strong>${spot.connectorType}</strong></div>
                    <div class="spot-power">‚ö° ${spot.powerOutput} kW</div>
                    <div>üí∞ ${spot.pricePerKwh.toLocaleString()} ƒë/kWh</div>
                    <div style="font-size: 12px; color: #9CA3AF; margin-top: 8px;">
                        ${spot.description || ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function initMap() {
    const defaultCenter = [10.8231, 106.6297];
    mapInstance = L.map('stationMap').setView(defaultCenter, 15);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(mapInstance);
    
    setTimeout(() => {
        if (mapInstance.invalidateSize) mapInstance.invalidateSize();
    }, 300);
}

function updateMap() {
    if (!stationData || !mapInstance) return;
    
    const lat = stationData.latitude;
    const lng = stationData.longitude;
    
    if (lat && lng) {
        mapInstance.setView([lat, lng], 16);
        
        const icon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background:#00A63E;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        
        L.marker([lat, lng], {icon: icon}).addTo(mapInstance)
            .bindPopup(`<b>${stationData.name}</b><br/>${stationData.address}`);
    }
}

function loadRecentActivity() {
    // Mock data for now
    const activityList = document.getElementById('activityList');
    activityList.innerHTML = `
        <div class="activity-item session-start">
            <div class="activity-time">2 ph√∫t tr∆∞·ªõc</div>
            <div class="activity-text">Phi√™n s·∫°c m·ªõi b·∫Øt ƒë·∫ßu t·∫°i <strong>Spot A01</strong></div>
        </div>
        <div class="activity-item session-end">
            <div class="activity-time">15 ph√∫t tr∆∞·ªõc</div>
            <div class="activity-text">Phi√™n s·∫°c k·∫øt th√∫c t·∫°i <strong>Spot A02</strong> - 25.5 kWh</div>
        </div>
        <div class="activity-item error">
            <div class="activity-time">1 gi·ªù tr∆∞·ªõc</div>
            <div class="activity-text">L·ªói ƒë∆∞·ª£c b√°o c√°o t·∫°i <strong>Spot A03</strong></div>
        </div>
    `;
}

function showSpotDetail(spotId) {
    // Show modal with spot details
    alert('Chi ti·∫øt Spot: ' + spotId + '\n(S·∫Ω hi·ªÉn th·ªã modal ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i)');
}

function toggleMaintenance() {
    if (confirm('Chuy·ªÉn tr·∫°m sang ch·∫ø ƒë·ªô b·∫£o tr√¨?')) {
        alert('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn');
    }
}

function closeSpotModal() {
    document.getElementById('spotModal').style.display = 'none';
}

function updateSpotStatus() {
    alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i spot');
}
</script>

<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #6B7280;
        line-height: 1;
    }

    .modal-close:hover {
        color: #374151;
    }

    .modal-body {
        padding: 24px;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #E5E7EB;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
</style>

