@page 
@model PresentationLayer.Pages.Staff.IndexModel
@{
    Layout = "~/Pages/Shared/_DashboardLayout.cshtml";
    ViewData["Title"] = "Staff ‚Ä¢ T·ªïng quan";
}

<style>
    .staff-dashboard {
        padding: 24px;
        background: #F9FAFB;
        min-height: 100vh;
    }

    .page-header {
        margin-bottom: 32px;
    }

    .page-header h2 {
        font-size: 28px;
        font-weight: 600;
        color: #101828;
        margin: 0 0 8px 0;
    }

    .page-subtitle {
        font-size: 14px;
        color: #4A5565;
    }

    /* KPI Cards */
    .kpis {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .kpi-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #E5E7EB;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #00A63E 0%, #008631 100%);
        opacity: 0;
        transition: opacity 0.3s;
    }

    .kpi-card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        transform: translateY(-4px);
        border-color: #00A63E;
    }

    .kpi-card:hover::before {
        opacity: 1;
    }

    .kpi-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
    }

    .kpi-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        flex-shrink: 0;
    }

    .kpi-icon.green { 
        background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
    }
    .kpi-icon.blue { 
        background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
    }
    .kpi-icon.orange { 
        background: linear-gradient(135deg, #FED7AA 0%, #FDE68A 100%);
    }
    .kpi-icon.red { 
        background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
    }

    .kpi-content {
        flex: 1;
        min-width: 0;
    }

    .kpi-label {
        font-size: 13px;
        font-weight: 600;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
    }

    .kpi-value {
        font-size: 36px;
        font-weight: 800;
        color: #101828;
        line-height: 1;
        margin-bottom: 12px;
        font-family: 'Inter', -apple-system, sans-serif;
    }

    .kpi-change {
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
    }

    .kpi-change.positive { 
        color: #10B981;
    }
    .kpi-change.negative { 
        color: #EF4444;
    }
    .kpi-change.neutral {
        color: #6B7280;
    }

    /* Quick Actions */
    .quick-actions {
        margin-bottom: 32px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #101828;
        margin-bottom: 16px;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .action-card {
        background: white;
        border: 2px solid #E5E7EB;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        color: inherit;
    }

    .action-card:hover {
        border-color: #00A63E;
        box-shadow: 0 4px 12px rgba(0, 166, 62, 0.15);
        transform: translateY(-2px);
    }

    .action-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        background: linear-gradient(135deg, #00A63E 0%, #008631 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        font-size: 28px;
    }

    .action-title {
        font-size: 16px;
        font-weight: 600;
        color: #101828;
        margin-bottom: 4px;
    }

    .action-desc {
        font-size: 13px;
        color: #6B7280;
    }

    /* Active Sessions Table */
    .active-sessions {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #E5E7EB;
    }

    .session-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .refresh-btn {
        background: #F3F4F6;
        border: 1px solid #D1D5DB;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
    }

    .refresh-btn:hover {
        background: #E5E7EB;
    }

    .sessions-table {
        width: 100%;
        border-collapse: collapse;
    }

    .sessions-table thead {
        background: #F9FAFB;
        border-bottom: 2px solid #E5E7EB;
    }

    .sessions-table th {
        padding: 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .sessions-table td {
        padding: 16px 12px;
        border-bottom: 1px solid #E5E7EB;
        font-size: 14px;
        color: #374151;
    }

    .sessions-table tr:hover {
        background: #F9FAFB;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-badge.active {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-badge.paused {
        background: #FED7AA;
        color: #92400E;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #00A63E 0%, #008631 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-sm {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #00A63E;
        color: white;
    }

    .btn-primary:hover {
        background: #008631;
    }

    .btn-danger {
        background: #EF4444;
        color: white;
    }

    .btn-danger:hover {
        background: #DC2626;
    }

    .btn-secondary {
        background: #F3F4F6;
        color: #374151;
        border: 1px solid #D1D5DB;
    }

    .btn-secondary:hover {
        background: #E5E7EB;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6B7280;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-text {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .empty-subtext {
        font-size: 14px;
    }

    @@media (max-width: 768px) {
        .staff-dashboard {
            padding: 16px;
        }

        .kpis {
            grid-template-columns: 1fr;
        }

        .actions-grid {
            grid-template-columns: 1fr;
        }

        .sessions-table {
            display: block;
            overflow-x: auto;
        }
    }
</style>

<div class="staff-dashboard">
    <section class="page-header">
        <h2>T·ªïng quan tr·∫°m s·∫°c</h2>
        <p class="page-subtitle">Qu·∫£n l√Ω v√† theo d√µi ho·∫°t ƒë·ªông tr·∫°m s·∫°c</p>
    </section>

    <!-- KPI Cards -->
    <section class="kpis">
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-icon green">‚ö°</div>
                <div class="kpi-content">
                    <div class="kpi-label">Phi√™n s·∫°c ƒëang ho·∫°t ƒë·ªông</div>
                    <div class="kpi-value" id="activeSessions">0</div>
                </div>
            </div>
            <div class="kpi-change positive">
                <span>‚Üë 8% ƒë√£ ho·∫°t ƒë·ªông</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-icon blue">üîå</div>
                <div class="kpi-content">
                    <div class="kpi-label">ƒêi·ªÉm s·∫°c kh·∫£ d·ª•ng</div>
                    <div class="kpi-value" id="availableSpots">0</div>
                </div>
            </div>
            <div class="kpi-change positive">
                <span>S·∫µn s√†ng ph·ª•c v·ª•</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-icon orange">‚ö†Ô∏è</div>
                <div class="kpi-content">
                    <div class="kpi-label">B√°o c√°o l·ªói ch·ªù x·ª≠ l√Ω</div>
                    <div class="kpi-value" id="pendingErrors">0</div>
                </div>
            </div>
            <div class="kpi-change neutral" id="pendingErrorsChange">
                <span>‚Üì 3 c·∫ßn x·ª≠ l√Ω ngay</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-icon red">üîß</div>
                <div class="kpi-content">
                    <div class="kpi-label">B·∫£o tr√¨ h√¥m nay</div>
                    <div class="kpi-value" id="todayMaintenance">0</div>
                </div>
            </div>
            <div class="kpi-change neutral">
                <span>2 ƒë√£ ho√†n th√†nh</span>
            </div>
        </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions">
        <h3 class="section-title">Thao t√°c nhanh</h3>
        <div class="actions-grid">
            <a href="/Staff/Sessions" class="action-card">
                <div class="action-icon">‚ö°</div>
                <div class="action-title">Qu·∫£n l√Ω phi√™n s·∫°c</div>
                <div class="action-desc">Kh·ªüi ƒë·ªông, d·ª´ng phi√™n s·∫°c</div>
            </a>
            <a href="/Staff/Stations" class="action-card">
                <div class="action-icon">üìç</div>
                <div class="action-title">Theo d√µi tr·∫°m</div>
                <div class="action-desc">Tr·∫°ng th√°i ƒëi·ªÉm s·∫°c</div>
            </a>
            <a href="/Staff/Errors" class="action-card">
                <div class="action-icon">üîî</div>
                <div class="action-title">B√°o c√°o l·ªói</div>
                <div class="action-desc">Xem v√† x·ª≠ l√Ω s·ª± c·ªë</div>
            </a>
            <a href="/Staff/Reports" class="action-card">
                <div class="action-icon">üìä</div>
                <div class="action-title">B√°o c√°o</div>
                <div class="action-desc">Th·ªëng k√™ ho·∫°t ƒë·ªông</div>
            </a>
        </div>
    </section>

    <!-- Active Sessions -->
    <section class="active-sessions">
        <div class="session-header">
            <h3 class="section-title" style="margin: 0;">Phi√™n s·∫°c ƒëang ho·∫°t ƒë·ªông</h3>
            <button class="refresh-btn" onclick="loadActiveSessions()">
                üîÑ L√†m m·ªõi
            </button>
        </div>

        <div id="sessionsTableContainer">
            <div class="empty-state">
                <div class="empty-icon">‚ö°</div>
                <div class="empty-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>
        </div>
    </section>
</div>

<script>
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        loadActiveSessions();
        
        // Auto refresh every 30 seconds
        setInterval(function() {
            loadActiveSessions();
            loadDashboardData();
        }, 30000);
    });

    async function loadDashboardData() {
        try {
            // Load active sessions count
            const sessionsResponse = await fetch('/api/ChargingSession/active');
            if (sessionsResponse.ok) {
                const sessions = await sessionsResponse.json();
                const activeCount = sessions.length;
                document.getElementById('activeSessions').textContent = activeCount;
                
                // Update change indicator
                const changeElem = document.querySelector('.kpi-card:nth-child(1) .kpi-change');
                if (activeCount > 0) {
                    changeElem.className = 'kpi-change positive';
                    changeElem.innerHTML = '<span>‚úì ' + activeCount + ' phi√™n ƒëang ho·∫°t ƒë·ªông</span>';
                } else {
                    changeElem.className = 'kpi-change neutral';
                    changeElem.innerHTML = '<span>Ch∆∞a c√≥ phi√™n s·∫°c n√†o</span>';
                }
            }

            // Load available spots count
            const spotsResponse = await fetch('/api/ChargingSpot/status/0'); // Available = 0
            if (spotsResponse.ok) {
                const spots = await spotsResponse.json();
                const availableCount = spots.length;
                document.getElementById('availableSpots').textContent = availableCount;
                
                // Update change indicator
                const changeElem = document.querySelector('.kpi-card:nth-child(2) .kpi-change');
                if (availableCount > 0) {
                    changeElem.className = 'kpi-change positive';
                    changeElem.innerHTML = '<span>‚úì S·∫µn s√†ng ph·ª•c v·ª•</span>';
                } else {
                    changeElem.className = 'kpi-change neutral';
                    changeElem.innerHTML = '<span>Kh√¥ng c√≥ ƒëi·ªÉm s·∫°c kh·∫£ d·ª•ng</span>';
                }
            }

            // Load pending errors count
            const errorsResponse = await fetch('/api/StationError/status/0'); // Reported = 0
            if (errorsResponse.ok) {
                const errors = await errorsResponse.json();
                const errorCount = errors.length;
                document.getElementById('pendingErrors').textContent = errorCount;
                
                // Update change indicator
                const changeElem = document.querySelector('.kpi-card:nth-child(3) .kpi-change');
                if (errorCount > 0) {
                    changeElem.className = 'kpi-change negative';
                    changeElem.innerHTML = '<span>‚ö†Ô∏è ' + errorCount + ' c·∫ßn x·ª≠ l√Ω ngay</span>';
                } else {
                    changeElem.className = 'kpi-change positive';
                    changeElem.innerHTML = '<span>‚úì Kh√¥ng c√≥ l·ªói</span>';
                }
            }

            // Load today's maintenance count
            const maintenanceResponse = await fetch('/api/StationMaintenance/status/0'); // Scheduled = 0
            if (maintenanceResponse.ok) {
                const maintenance = await maintenanceResponse.json();
                const today = new Date().toDateString();
                const todayMaintenance = maintenance.filter(m => 
                    new Date(m.scheduledDate).toDateString() === today
                );
                const maintenanceCount = todayMaintenance.length;
                document.getElementById('todayMaintenance').textContent = maintenanceCount;
                
                // Update change indicator
                const changeElem = document.querySelector('.kpi-card:nth-child(4) .kpi-change');
                if (maintenanceCount > 0) {
                    changeElem.className = 'kpi-change neutral';
                    changeElem.innerHTML = '<span>üìÖ ' + maintenanceCount + ' l·ªãch h√¥m nay</span>';
                } else {
                    changeElem.className = 'kpi-change positive';
                    changeElem.innerHTML = '<span>‚úì Kh√¥ng c√≥ l·ªãch b·∫£o tr√¨</span>';
                }
            }
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            // Set default values on error
            document.getElementById('activeSessions').textContent = '‚Äî';
            document.getElementById('availableSpots').textContent = '‚Äî';
            document.getElementById('pendingErrors').textContent = '‚Äî';
            document.getElementById('todayMaintenance').textContent = '‚Äî';
        }
    }

    async function loadActiveSessions() {
        try {
            const response = await fetch('/api/ChargingSession/active');
            if (!response.ok) throw new Error('Failed to fetch sessions');

            const sessions = await response.json();
            const container = document.getElementById('sessionsTableContainer');

            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö°</div>
                        <div class="empty-text">Kh√¥ng c√≥ phi√™n s·∫°c n√†o ƒëang ho·∫°t ƒë·ªông</div>
                        <div class="empty-subtext">C√°c phi√™n s·∫°c m·ªõi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</div>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table class="sessions-table">
                    <thead>
                        <tr>
                            <th>Kh√°ch h√†ng</th>
                            <th>Tr·∫°m s·∫°c</th>
                            <th>ƒêi·ªÉm s·∫°c</th>
                            <th>Th·ªùi gian b·∫Øt ƒë·∫ßu</th>
                            <th>NƒÉng l∆∞·ª£ng (kWh)</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sessions.forEach(session => {
                const startTime = new Date(session.startTime);
                const duration = Math.floor((new Date() - startTime) / 60000); // minutes
                const initials = session.userFullName ? session.userFullName.split(' ').map(n => n[0]).join('') : 'U';

                tableHTML += `
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">${initials}</div>
                                <div>
                                    <div style="font-weight: 600;">${session.userFullName || 'Unknown'}</div>
                                    <div style="font-size: 12px; color: #6B7280;">${duration} ph√∫t tr∆∞·ªõc</div>
                                </div>
                            </div>
                        </td>
                        <td>${session.chargingStationName || 'N/A'}</td>
                        <td><strong>${session.chargingSpotNumber || 'N/A'}</strong></td>
                        <td>${startTime.toLocaleString('vi-VN')}</td>
                        <td><strong>${session.energyConsumed.toFixed(2)}</strong></td>
                        <td>
                            <span class="status-badge ${session.status === 0 ? 'active' : 'paused'}">
                                ${session.status === 0 ? 'ƒêang s·∫°c' : 'T·∫°m d·ª´ng'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${session.status === 0 
                                    ? `<button class="btn-sm btn-secondary" onclick="pauseSession('${session.id}')">‚è∏Ô∏è T·∫°m d·ª´ng</button>`
                                    : `<button class="btn-sm btn-primary" onclick="resumeSession('${session.id}')">‚ñ∂Ô∏è Ti·∫øp t·ª•c</button>`
                                }
                                <button class="btn-sm btn-danger" onclick="stopSession('${session.id}')">‚èπÔ∏è D·ª´ng</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        } catch (error) {
            console.error('Error loading active sessions:', error);
            document.getElementById('sessionsTableContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ùå</div>
                    <div class="empty-text">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</div>
                    <div class="empty-subtext">${error.message}</div>
                </div>
            `;
        }
    }

    async function stopSession(sessionId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën d·ª´ng phi√™n s·∫°c n√†y?')) return;

        try {
            const response = await fetch(`/api/ChargingSession/${sessionId}/stop`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    energyConsumed: 0,
                    totalCost: 0,
                    paymentMethod: 'Cash',
                    notes: 'Stopped by staff'
                })
            });

            if (response.ok) {
                alert('ƒê√£ d·ª´ng phi√™n s·∫°c th√†nh c√¥ng!');
                loadActiveSessions();
                loadDashboardData();
            } else {
                alert('Kh√¥ng th·ªÉ d·ª´ng phi√™n s·∫°c. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        } catch (error) {
            console.error('Error stopping session:', error);
            alert('ƒê√£ x·∫£y ra l·ªói: ' + error.message);
        }
    }

    async function pauseSession(sessionId) {
        try {
            const response = await fetch(`/api/ChargingSession/${sessionId}/pause`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify('Paused by staff')
            });

            if (response.ok) {
                alert('ƒê√£ t·∫°m d·ª´ng phi√™n s·∫°c!');
                loadActiveSessions();
            } else {
                alert('Kh√¥ng th·ªÉ t·∫°m d·ª´ng phi√™n s·∫°c.');
            }
        } catch (error) {
            console.error('Error pausing session:', error);
            alert('ƒê√£ x·∫£y ra l·ªói: ' + error.message);
        }
    }

    async function resumeSession(sessionId) {
        try {
            const response = await fetch(`/api/ChargingSession/${sessionId}/resume`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify('Resumed by staff')
            });

            if (response.ok) {
                alert('ƒê√£ ti·∫øp t·ª•c phi√™n s·∫°c!');
                loadActiveSessions();
            } else {
                alert('Kh√¥ng th·ªÉ ti·∫øp t·ª•c phi√™n s·∫°c.');
            }
        } catch (error) {
            console.error('Error resuming session:', error);
            alert('ƒê√£ x·∫£y ra l·ªói: ' + error.message);
        }
    }
</script>
