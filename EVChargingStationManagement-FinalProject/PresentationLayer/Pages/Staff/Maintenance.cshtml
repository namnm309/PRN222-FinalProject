@page
@model PresentationLayer.Pages.Staff.MaintenanceModel
@{
    Layout = "~/Pages/Shared/_DashboardLayout.cshtml";
    ViewData["Title"] = "Staff ‚Ä¢ B·∫£o tr√¨ tr·∫°m s·∫°c";
}

<link rel="stylesheet" href="/css/staff-common.css">

<style>
    .maintenance-page {
        padding: 24px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .page-title h2 {
        font-size: 28px;
        font-weight: 700;
        color: #101828;
        margin: 0 0 8px 0;
    }

    .page-subtitle {
        font-size: 14px;
        color: #6B7280;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: #00A63E;
        color: white;
    }

    .btn-primary:hover {
        background: #008631;
    }

    .btn-outline {
        background: white;
        color: #374151;
        border: 1px solid #D1D5DB;
    }

    .btn-outline:hover {
        background: #F9FAFB;
    }

    /* Filters */
    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
        display: flex;
        gap: 16px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 180px;
    }

    .filter-group label {
        font-size: 13px;
        font-weight: 500;
        color: #374151;
    }

    .filter-select {
        padding: 8px 12px;
        border: 1px solid #D1D5DB;
        border-radius: 8px;
        font-size: 14px;
        color: #1F2937;
    }

    /* Stats */
    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .stat-label {
        font-size: 13px;
        color: #6B7280;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #101828;
    }

    /* Maintenance List */
    .maintenance-list {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .maintenance-card {
        padding: 20px;
        border-bottom: 1px solid #E5E7EB;
        transition: all 0.2s;
    }

    .maintenance-card:hover {
        background: #F9FAFB;
    }

    .maintenance-card:last-child {
        border-bottom: none;
    }

    .maintenance-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .maintenance-title {
        font-size: 16px;
        font-weight: 600;
        color: #101828;
        margin-bottom: 4px;
    }

    .maintenance-station {
        font-size: 14px;
        color: #6B7280;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .status-scheduled {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .status-in-progress {
        background: #FED7AA;
        color: #92400E;
    }

    .status-completed {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-cancelled {
        background: #F3F4F6;
        color: #4B5563;
    }

    .maintenance-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 12px;
        font-size: 13px;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .detail-label {
        color: #6B7280;
        font-size: 12px;
    }

    .detail-value {
        color: #374151;
        font-weight: 500;
    }

    .maintenance-description {
        font-size: 14px;
        color: #4B5563;
        line-height: 1.6;
        margin-bottom: 12px;
    }

    .maintenance-actions {
        display: flex;
        gap: 8px;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 6px;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #6B7280;
        line-height: 1;
    }

    .modal-body {
        padding: 24px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #D1D5DB;
        border-radius: 8px;
        font-size: 14px;
    }

    .form-control:focus {
        outline: none;
        border-color: #00A63E;
        box-shadow: 0 0 0 3px rgba(0, 166, 62, 0.1);
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #E5E7EB;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    @@media (max-width: 768px) {
        .maintenance-details {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="maintenance-page">
    <!-- Header -->
    <section class="page-header">
        <div>
            <div class="page-title">
                <h2>B·∫£o tr√¨ tr·∫°m s·∫°c</h2>
            </div>
            <p class="page-subtitle">Qu·∫£n l√Ω l·ªãch b·∫£o tr√¨ v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i tr·∫°m s·∫°c</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openCreateModal()">
                ‚ûï Th√™m l·ªãch b·∫£o tr√¨
            </button>
            <button class="btn btn-outline" onclick="loadMaintenanceList()">
                üîÑ L√†m m·ªõi
            </button>
        </div>
    </section>

    <!-- Filters -->
    <section class="filters-section">
        <div class="filter-group">
            <label>Tr·∫°m s·∫°c</label>
            <select class="filter-select" id="filterStation" onchange="loadMaintenanceList()">
                <option value="">T·∫•t c·∫£ tr·∫°m</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Tr·∫°ng th√°i</label>
            <select class="filter-select" id="filterStatus" onchange="loadMaintenanceList()">
                <option value="">T·∫•t c·∫£</option>
                <option value="0">ƒê√£ l√™n l·ªãch</option>
                <option value="1">ƒêang th·ª±c hi·ªán</option>
                <option value="2">Ho√†n th√†nh</option>
                <option value="3">ƒê√£ h·ªßy</option>
            </select>
        </div>
        <div class="filter-group">
            <label>T·ª´ ng√†y</label>
            <input type="date" class="filter-select" id="filterFromDate" onchange="loadMaintenanceList()">
        </div>
        <div class="filter-group">
            <label>ƒê·∫øn ng√†y</label>
            <input type="date" class="filter-select" id="filterToDate" onchange="loadMaintenanceList()">
        </div>
    </section>

    <!-- Stats -->
    <section class="stats-section">
        <div class="stat-card">
            <div class="stat-label">T·ªïng s·ªë l·ªãch</div>
            <div class="stat-value" id="totalMaintenance">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ƒê√£ l√™n l·ªãch</div>
            <div class="stat-value" id="scheduledMaintenance">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ƒêang th·ª±c hi·ªán</div>
            <div class="stat-value" id="inProgressMaintenance">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Ho√†n th√†nh th√°ng n√†y</div>
            <div class="stat-value" id="completedMaintenance">0</div>
        </div>
    </section>

    <!-- Maintenance List -->
    <section class="maintenance-list" id="maintenanceList">
        <div style="padding: 40px; text-align: center; color: #6B7280;">
            ƒêang t·∫£i...
        </div>
    </section>
</div>

<!-- Create/Edit Modal -->
<div id="maintenanceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Th√™m l·ªãch b·∫£o tr√¨</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="maintenanceForm">
                <input type="hidden" id="maintenanceId">
                
                <div class="form-group">
                    <label>Tr·∫°m s·∫°c <span style="color: red;">*</span></label>
                    <select class="form-control" id="stationId" required>
                        <option value="">Ch·ªçn tr·∫°m s·∫°c</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ƒêi·ªÉm s·∫°c (t√πy ch·ªçn)</label>
                    <select class="form-control" id="spotId">
                        <option value="">To√†n b·ªô tr·∫°m</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ti√™u ƒë·ªÅ <span style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="title" required placeholder="Vd: B·∫£o tr√¨ ƒë·ªãnh k·ª≥">
                </div>

                <div class="form-group">
                    <label>M√¥ t·∫£ <span style="color: red;">*</span></label>
                    <textarea class="form-control" id="description" required placeholder="M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác b·∫£o tr√¨"></textarea>
                </div>

                <div class="form-group">
                    <label>Ng√†y l√™n l·ªãch <span style="color: red;">*</span></label>
                    <input type="datetime-local" class="form-control" id="scheduledDate" required>
                </div>

                <div class="form-group">
                    <label>Ng∆∞·ªùi ph·ª• tr√°ch (t√πy ch·ªçn)</label>
                    <select class="form-control" id="assignedToUserId">
                        <option value="">Ch∆∞a ph√¢n c√¥ng</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ghi ch√∫</label>
                    <textarea class="form-control" id="notes" placeholder="Ghi ch√∫ th√™m"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal()">H·ªßy</button>
            <button class="btn btn-primary" onclick="saveMaintenance()">L∆∞u</button>
        </div>
    </div>
</div>

<script>
let maintenanceData = [];
let stationsData = [];

document.addEventListener('DOMContentLoaded', function() {
    loadStations();
    loadMaintenanceList();
});

async function loadStations() {
    try {
        const response = await fetch('/api/Maps/charging-stations');
        const data = await response.json();
        
        if (data.success && data.stations) {
            stationsData = data.stations;
            populateStationFilters();
        }
    } catch (error) {
        console.error('Error loading stations:', error);
    }
}

function populateStationFilters() {
    const filterSelect = document.getElementById('filterStation');
    const modalSelect = document.getElementById('stationId');
    
    const options = stationsData.map(s => 
        `<option value="${s.id}">${s.name}</option>`
    ).join('');
    
    filterSelect.innerHTML = '<option value="">T·∫•t c·∫£ tr·∫°m</option>' + options;
    modalSelect.innerHTML = '<option value="">Ch·ªçn tr·∫°m s·∫°c</option>' + options;
}

async function loadMaintenanceList() {
    try {
        const response = await fetch('/api/StationMaintenance');
        const data = await response.json();
        
        maintenanceData = Array.isArray(data) ? data : [];
        displayMaintenanceList();
        updateStats();
    } catch (error) {
        console.error('Error loading maintenance:', error);
        displayEmptyState();
    }
}

function displayMaintenanceList() {
    const listContainer = document.getElementById('maintenanceList');
    
    if (maintenanceData.length === 0) {
        displayEmptyState();
        return;
    }

    const statusMap = {
        0: { class: 'scheduled', text: 'üìÖ ƒê√£ l√™n l·ªãch' },
        1: { class: 'in-progress', text: 'üîß ƒêang th·ª±c hi·ªán' },
        2: { class: 'completed', text: '‚úÖ Ho√†n th√†nh' },
        3: { class: 'cancelled', text: '‚ùå ƒê√£ h·ªßy' }
    };
    
    const html = maintenanceData.map(m => {
        const status = statusMap[m.status] || statusMap[0];
        const station = stationsData.find(s => s.id === m.chargingStationId);
        const stationName = station ? station.name : 'N/A';
        
        return `
            <div class="maintenance-card">
                <div class="maintenance-header">
                    <div>
                        <div class="maintenance-title">${m.title}</div>
                        <div class="maintenance-station">üìç ${stationName}</div>
                    </div>
                    <span class="status-badge status-${status.class}">${status.text}</span>
                </div>
                
                <div class="maintenance-details">
                    <div class="detail-item">
                        <span class="detail-label">Ng√†y l√™n l·ªãch</span>
                        <span class="detail-value">${formatDate(m.scheduledDate)}</span>
                    </div>
                    ${m.startDate ? `
                    <div class="detail-item">
                        <span class="detail-label">Ng√†y b·∫Øt ƒë·∫ßu</span>
                        <span class="detail-value">${formatDate(m.startDate)}</span>
                    </div>` : ''}
                    ${m.endDate ? `
                    <div class="detail-item">
                        <span class="detail-label">Ng√†y k·∫øt th√∫c</span>
                        <span class="detail-value">${formatDate(m.endDate)}</span>
                    </div>` : ''}
                    ${m.assignedToUser ? `
                    <div class="detail-item">
                        <span class="detail-label">Ng∆∞·ªùi ph·ª• tr√°ch</span>
                        <span class="detail-value">${m.assignedToUser.fullName || 'N/A'}</span>
                    </div>` : ''}
                </div>
                
                <div class="maintenance-description">${m.description}</div>
                
                <div class="maintenance-actions">
                    ${m.status === 0 ? `
                        <button class="btn btn-primary btn-small" onclick="startMaintenance('${m.id}')">üöÄ B·∫Øt ƒë·∫ßu</button>
                    ` : ''}
                    ${m.status === 1 ? `
                        <button class="btn btn-primary btn-small" onclick="completeMaintenance('${m.id}')">‚úÖ Ho√†n th√†nh</button>
                    ` : ''}
                    <button class="btn btn-outline btn-small" onclick="editMaintenance('${m.id}')">‚úèÔ∏è S·ª≠a</button>
                    <button class="btn btn-outline btn-small" onclick="deleteMaintenance('${m.id}')">üóëÔ∏è X√≥a</button>
                </div>
            </div>
        `;
    }).join('');
    
    listContainer.innerHTML = html;
}

function displayEmptyState() {
    document.getElementById('maintenanceList').innerHTML = `
        <div style="padding: 60px; text-align: center; color: #6B7280;">
            <div style="font-size: 48px; margin-bottom: 16px;">üîß</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨</div>
            <div style="font-size: 14px; color: #9CA3AF;">Nh·∫•n "Th√™m l·ªãch b·∫£o tr√¨" ƒë·ªÉ t·∫°o l·ªãch m·ªõi</div>
        </div>
    `;
}

function updateStats() {
    const total = maintenanceData.length;
    const scheduled = maintenanceData.filter(m => m.status === 0).length;
    const inProgress = maintenanceData.filter(m => m.status === 1).length;
    const completed = maintenanceData.filter(m => {
        const date = new Date(m.endDate);
        const now = new Date();
        return m.status === 2 && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
    }).length;
    
    document.getElementById('totalMaintenance').textContent = total;
    document.getElementById('scheduledMaintenance').textContent = scheduled;
    document.getElementById('inProgressMaintenance').textContent = inProgress;
    document.getElementById('completedMaintenance').textContent = completed;
}

function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const date = new Date(dateStr);
    return date.toLocaleString('vi-VN', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'Th√™m l·ªãch b·∫£o tr√¨';
    document.getElementById('maintenanceForm').reset();
    document.getElementById('maintenanceId').value = '';
    document.getElementById('maintenanceModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('maintenanceModal').style.display = 'none';
}

async function saveMaintenance() {
    const id = document.getElementById('maintenanceId').value;
    const data = {
        chargingStationId: document.getElementById('stationId').value,
        chargingSpotId: document.getElementById('spotId').value || null,
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        scheduledDate: document.getElementById('scheduledDate').value,
        assignedToUserId: document.getElementById('assignedToUserId').value || null,
        notes: document.getElementById('notes').value
    };
    
    if (!data.chargingStationId || !data.title || !data.description || !data.scheduledDate) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
        return;
    }
    
    try {
        const url = id ? `/api/StationMaintenance/${id}` : '/api/StationMaintenance';
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('L∆∞u th√†nh c√¥ng!');
            closeModal();
            loadMaintenanceList();
        } else {
            alert('L·ªói khi l∆∞u: ' + response.statusText);
        }
    } catch (error) {
        console.error('Error saving maintenance:', error);
        alert('L·ªói khi l∆∞u');
    }
}

async function startMaintenance(id) {
    if (!confirm('B·∫Øt ƒë·∫ßu b·∫£o tr√¨?')) return;
    
    const maintenance = maintenanceData.find(m => m.id === id);
    if (!maintenance) return;
    
    maintenance.status = 1;
    maintenance.startDate = new Date().toISOString();
    
    try {
        const response = await fetch(`/api/StationMaintenance/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(maintenance)
        });
        
        if (response.ok) {
            loadMaintenanceList();
        }
    } catch (error) {
        console.error('Error starting maintenance:', error);
    }
}

async function completeMaintenance(id) {
    if (!confirm('ƒê√°nh d·∫•u ho√†n th√†nh?')) return;
    
    const maintenance = maintenanceData.find(m => m.id === id);
    if (!maintenance) return;
    
    maintenance.status = 2;
    maintenance.endDate = new Date().toISOString();
    
    try {
        const response = await fetch(`/api/StationMaintenance/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(maintenance)
        });
        
        if (response.ok) {
            loadMaintenanceList();
        }
    } catch (error) {
        console.error('Error completing maintenance:', error);
    }
}

function editMaintenance(id) {
    alert('Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn: Edit maintenance ' + id);
}

async function deleteMaintenance(id) {
    if (!confirm('X√≥a l·ªãch b·∫£o tr√¨ n√†y?')) return;
    
    try {
        const response = await fetch(`/api/StationMaintenance/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadMaintenanceList();
        }
    } catch (error) {
        console.error('Error deleting maintenance:', error);
    }
}
</script>

