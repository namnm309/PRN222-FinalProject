@page
@model IndexModel
@{
    ViewData["Title"] = "Trang chủ";
}

<div class="homepage-container">
    <!-- Left Sidebar -->
    <div class="sidebar-left">
        <div class="sidebar-content">
            <!-- Header Section -->
            <div class="sidebar-header">
                <h1 class="sidebar-title">Tìm trạm sạc gần bạn</h1>
                <p class="sidebar-subtitle">Khám phá các trạm sạc xe điện xung quanh</p>
            </div>

            

            <!-- Stats Cards -->
            <div class="stats-cards">
                <div class="stat-card stat-card-green">
                    <div class="stat-value" id="stat-total" data-default="0">0</div>
                    <div class="stat-label">Trạm sạc</div>
                </div>
                <div class="stat-card stat-card-blue">
                    <div class="stat-value" id="stat-rated" data-default="0">0</div>
                    <div class="stat-label">Có đánh giá</div>
                </div>
                <div class="stat-card stat-card-purple">
                    <div class="stat-value" id="stat-average" data-default="--">--</div>
                    <div class="stat-label">Điểm TB</div>
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <div class="search-input-wrapper">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="9" cy="9" r="6" stroke="#717182" stroke-width="1.5"/>
                        <path d="M14 14L17 17" stroke="#717182" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <input type="text" class="search-input" placeholder="Tìm kiếm trạm sạc...">
                </div>
            </div>

            <!-- Filter Section -->
            <div class="filter-section" style="margin-top: 16px; padding: 16px; background: white; border-radius: 12px;">
                <h4 style="margin: 0 0 12px 0; font-size: 0.9rem; font-weight: 600;">Bộ lọc</h4>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 0.85rem; color: #6b7280;">Loại cổng sạc</label>
                    <select id="filter-connector-type" class="form-select form-select-sm">
                        <option value="">Tất cả</option>
                        <option value="Type 2">Type 2</option>
                        <option value="CCS">CCS</option>
                        <option value="CHAdeMO">CHAdeMO</option>
                    </select>
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 0.85rem; color: #6b7280;">Trạng thái</label>
                    <select id="filter-status" class="form-select form-select-sm">
                        <option value="">Tất cả</option>
                        <option value="Available">Còn trống</option>
                        <option value="Occupied">Đang bận</option>
                        <option value="Full">Đầy</option>
                    </select>
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 0.85rem; color: #6b7280;">Sắp xếp</label>
                    <select id="filter-sort" class="form-select form-select-sm">
                        <option value="distance">Khoảng cách</option>
                        <option value="rating">Đánh giá</option>
                        <option value="name">Tên</option>
                    </select>
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 0.85rem; color: #6b7280;">Bán kính: <span id="radius-value">10</span> km</label>
                    <input type="range" id="filter-radius" class="form-range" min="1" max="50" value="10" step="1">
                </div>

                <button id="btn-apply-filters" class="btn btn-primary btn-sm w-100" onclick="if(typeof applyFilters === 'function') applyFilters(); else alert('Bộ lọc đang được khởi tạo, vui lòng đợi...'); return false;">Áp dụng bộ lọc</button>
            </div>

            <!-- Station List -->
            <div class="station-list-header">
                <p class="station-count" id="station-count-text" data-default="Chưa có trạm nào được hiển thị">Chưa có trạm nào được hiển thị</p>
            </div>

            <div class="station-list" id="station-list">
                <div class="station-empty">
                    Vui lòng cho phép truy cập vị trí để hiển thị các trạm sạc quanh bạn.
                </div>
            </div>
        </div>
    </div>

    <!-- Right Map Section -->
    <div class="map-section">
        <div id="map" class="map-container">
            <!-- Map Placeholder -->
            <div class="map-placeholder">
                <div class="map-placeholder-icon">
                    <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M32 8C20.9543 8 12 16.9543 12 28C12 42 32 56 32 56C32 56 52 42 52 28C52 16.9543 43.0457 8 32 8Z" stroke="#6A7282" stroke-width="2"/>
                        <circle cx="32" cy="28" r="8" stroke="#6A7282" stroke-width="2"/>
                    </svg>
                </div>
                <h3 class="map-placeholder-title">Bản đồ trạm sạc</h3>
                <p class="map-placeholder-text">Chọn một trạm sạc từ danh sách bên trái để xem chi tiết và chỉ đường</p>
            </div>
        </div>
        
        <!-- Map Info Card (Hidden by default, shown when station selected) -->
        <div class="map-info-card" style="display: none;">
            <button class="map-info-close-btn" id="btn-close-map-info" onclick="closeMapInfoCard()" aria-label="Đóng">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 5L5 15M5 5L15 15" stroke="#4A5565" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="map-info-header">
                <div class="map-info-title-section">
                    <h3 class="map-info-title" data-field="title">Trạm sạc</h3>
                    <div class="map-info-address">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2C5.24 2 3 4.24 3 7C3 10.5 8 14 8 14C8 14 13 10.5 13 7C13 4.24 10.76 2 8 2Z" stroke="#4A5565" stroke-width="1.5"/>
                            <circle cx="8" cy="7" r="2" stroke="#4A5565" stroke-width="1.5"/>
                        </svg>
                        <span data-field="address">Đang cập nhật</span>
                    </div>
                </div>
                <span class="status-badge status-available" data-field="status">Đang cập nhật</span>
            </div>
            <div class="map-info-details">
                <div class="map-detail-grid">
                    <div class="map-detail-item">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 10H18M10 2V18" stroke="#4A5565" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <div>
                            <div class="map-detail-label">Cổng sạc</div>
                            <div class="map-detail-value" data-field="connectors">--</div>
                        </div>
                    </div>
                    <div class="map-detail-item">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 2V18M10 2L7 5M10 2L13 5M10 18L7 15M10 18L13 15" stroke="#4A5565" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <div>
                            <div class="map-detail-label">Khoảng cách</div>
                            <div class="map-detail-value" data-field="distance">--</div>
                        </div>
                    </div>
                    <div class="map-detail-item">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 2L5 7L10 12L15 7L10 2Z" stroke="#4A5565" stroke-width="1.5" stroke-linejoin="round"/>
                        </svg>
                        <div>
                            <div class="map-detail-label">Loại sạc</div>
                            <div class="map-detail-value" data-field="chargerType">--</div>
                        </div>
                    </div>
                    <div class="map-detail-item">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 2L12 8L18 9L13 13L14 19L10 15L6 19L7 13L2 9L8 8L10 2Z" stroke="#4A5565" stroke-width="1.5" stroke-linejoin="round"/>
                        </svg>
                        <div>
                            <div class="map-detail-label">Đánh giá</div>
                            <div class="map-detail-value" data-field="rating">--</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="map-info-footer">
                <div style="display: flex; gap: 8px;">
                    <button class="btn-direction" id="btn-direction">
                        <span>Chỉ đường</span>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 12L10 8L6 4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button class="btn-reserve" id="btn-reserve" style="display: none;">
                        <span>Đặt lịch</span>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2V14M8 2L5 5M8 2L11 5M8 14L5 11M8 14L11 11" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <button class="btn-start-charging" id="btn-start-charging" style="display: none;">
                        <span>Bắt đầu sạc</span>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2L12 6H9V10H7V6H4L8 2Z" fill="white"/>
                            <path d="M2 12H14V14H2V12Z" fill="white"/>
                        </svg>
                    </button>
                </div>
                <div class="map-price-section">
                    <div class="map-price-label">Giá sạc</div>
                    <div class="map-price-value" data-field="price">--</div>
                </div>
            </div>
        </div>

        <!-- Legend & Controls -->
        <div class="map-overlay-bar">
            <div class="map-legend">
                <div class="legend-title">Chú thích</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>Còn trống</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-yellow"></div>
                        <span>Đang bận</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-red"></div>
                        <span>Đầy</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>Vị trí của bạn</span>
                    </div>
                </div>
            </div>
            <button id="btn-current-location" class="btn-current-location-map" title="Vị trí của tôi" aria-label="Lấy vị trí hiện tại">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 2C6.48 2 3.5 4.98 3.5 8.5C3.5 13.25 10 18 10 18C10 18 16.5 13.25 16.5 8.5C16.5 4.98 13.52 2 10 2Z" stroke="currentColor" stroke-width="1.5"/>
                    <circle cx="10" cy="8.5" r="3" stroke="currentColor" stroke-width="1.5"/>
                </svg>
            </button>
            <button id="btn-search-nearby" class="btn-current-location-map" title="Tìm trạm sạc gần đây" aria-label="Tìm trạm sạc gần đây">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.5 2.5C5.46243 2.5 3 4.96243 3 8C3 11.0376 5.46243 13.5 8.5 13.5C9.93373 13.5 11.2392 12.9728 12.2513 12.0864L16.0821 15.9171C16.4727 16.3077 17.1058 16.3077 17.4964 15.9171C17.887 15.5266 17.887 14.8934 17.4964 14.5029L13.6657 10.6721C14.552 9.66096 15.0792 8.35549 15.0792 6.92176C15.0792 3.88419 12.6168 1.42176 9.57924 1.42176C8.14551 1.42176 6.84004 1.94894 5.82891 2.83529C4.81778 3.72165 4.2906 5.02712 4.2906 6.46085" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Modal Đặt trước -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reservationModalLabel">Đặt trước trạm sạc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reservationForm">
                    <input type="hidden" id="reservation-station-id" />
                    <input type="hidden" id="reservation-spot-id" />
                    
                    <div class="mb-3">
                        <label class="form-label">Trạm sạc</label>
                        <input type="text" class="form-control" id="reservation-station-name" readonly />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chọn cổng sạc <span class="text-danger">*</span></label>
                        <select class="form-select" id="reservation-spot-select" required>
                            <option value="">-- Chọn cổng sạc --</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chọn xe <span class="text-danger">*</span></label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="reservation-vehicle-select" required>
                                <option value="">-- Chọn xe --</option>
                            </select>
                            <button type="button" class="btn btn-outline-primary" id="btn-add-vehicle-reservation" title="Thêm xe mới">
                                <i class="bi bi-plus-circle"></i> Thêm xe
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Thời gian bắt đầu <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control" id="reservation-start-time" required />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Thời gian kết thúc <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control" id="reservation-end-time" required />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Năng lượng ước tính (kWh)</label>
                        <input type="number" class="form-control" id="reservation-energy" min="0" step="0.1" placeholder="Nhập năng lượng ước tính" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chi phí ước tính</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="reservation-estimated-cost" readonly />
                            <span class="input-group-text">VND</span>
                        </div>
                        <small class="text-muted">Chi phí sẽ được tính tự động dựa trên giá trạm sạc</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Phương thức thanh toán <span class="text-danger">*</span></label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCash" value="cash" checked>
                                <label class="form-check-label" for="paymentCash">
                                    Tiền mặt
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="paymentVNPay" value="vnpay">
                                <label class="form-check-label" for="paymentVNPay">
                                    VNPay
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ghi chú</label>
                        <textarea class="form-control" id="reservation-notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btn-submit-reservation">Xác nhận đặt lịch</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm xe (cho Reservation) -->
<div class="modal fade" id="addVehicleModalReservation" tabindex="-1" aria-labelledby="addVehicleModalReservationLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVehicleModalReservationLabel">Thêm xe mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-vehicle-form-reservation">
                    <div class="mb-3">
                        <label class="form-label">Hãng xe <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="vehicle-make-reservation" required placeholder="Ví dụ: Tesla, VinFast, ..." />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Biển số <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="vehicle-license-plate-reservation" required placeholder="Ví dụ: 30A-12345" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control" id="vehicle-model-reservation" placeholder="Ví dụ: Model 3, VF8, ..." />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chọn cổng sạc</label>
                        <select class="form-select" id="add-vehicle-spot-select-reservation">
                            <option value="">-- Chọn cổng sạc (tùy chọn) --</option>
                        </select>
                        <small class="text-muted">Cổng sạc ưa thích của xe này (không bắt buộc)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btn-save-vehicle-reservation">Lưu</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js" crossorigin="anonymous"></script>
    <script>
        var currentUserMarker = null;
        var mapInstance = null;
        var DEFAULT_COORDS = { lat: 21.0285, lng: 105.8542 };
        var serpMarkers = [];
        var stationListEl = document.getElementById('station-list');
        var stationCountTextEl = document.getElementById('station-count-text');
        var statTotalEl = document.getElementById('stat-total');
        var statRatedEl = document.getElementById('stat-rated');
        var statAverageEl = document.getElementById('stat-average');
        var mapInfoCard = document.querySelector('.map-info-card');
        var mapInfoFields = mapInfoCard ? {
            title: mapInfoCard.querySelector('[data-field="title"]'),
            address: mapInfoCard.querySelector('[data-field="address"]'),
            status: mapInfoCard.querySelector('[data-field="status"]'),
            connectors: mapInfoCard.querySelector('[data-field="connectors"]'),
            distance: mapInfoCard.querySelector('[data-field="distance"]'),
            chargerType: mapInfoCard.querySelector('[data-field="chargerType"]'),
            rating: mapInfoCard.querySelector('[data-field="rating"]'),
            price: mapInfoCard.querySelector('[data-field="price"]')
        } : {};
        var selectedStation = null;
        var dbStations = []; // Cache trạm từ database
        var isUserAuthenticated = false; // Sẽ được set từ server
        var signalRConnection = null; // SignalR connection
        window.isSearching = false; // Initialize search flag
        var subscribedStationId = null; // Currently subscribed station ID

        // Initialize SignalR connection
        async function initSignalR() {
            if (typeof signalR === 'undefined') {
                console.warn('SignalR library not loaded');
                return;
            }

            try {
                signalRConnection = new signalR.HubConnectionBuilder()
                    .withAutomaticReconnect()
                    .withUrl('/hubs/station')
                    .build();

                // Listen for station availability updates
                signalRConnection.on('StationAvailabilityUpdated', function(stationId, totalSpots, availableSpots) {
                    console.log('StationAvailabilityUpdated received:', stationId, totalSpots, availableSpots);
                    
                    // Update currently selected station if it matches
                    if (selectedStation && selectedStation.stationId && selectedStation.stationId === stationId) {
                        updateStationAvailabilityUI(stationId, totalSpots, availableSpots);
                    }
                    
                    // Refresh danh sách stations trong sidebar để cập nhật thông tin mới nhất
                    refreshStationsListForAvailabilityUpdate(stationId, totalSpots, availableSpots);
                });
                
                // Listen for spot reserved event (real-time locking)
                signalRConnection.on('SpotReserved', function(spotId, status) {
                    console.log('SpotReserved received:', spotId, status);
                    
                    // Reload spots list if reservation modal is open
                    var reservationModal = document.getElementById('reservationModal');
                    if (reservationModal && reservationModal.classList.contains('show')) {
                        var stationId = document.getElementById('reservation-station-id').value;
                        if (stationId) {
                            var currentStatus = selectedStation && selectedStation.stationId === stationId ? selectedStation.status : null;
                            loadSpotsForReservation(stationId, currentStatus);
                        }
                    }
                });
                
                // Listen for spots list updated
                signalRConnection.on('SpotsListUpdated', function(stationId) {
                    console.log('SpotsListUpdated received:', stationId);
                    
                    // Reload spots list if reservation modal is open for this station
                    var reservationModal = document.getElementById('reservationModal');
                    if (reservationModal && reservationModal.classList.contains('show')) {
                        var currentStationId = document.getElementById('reservation-station-id').value;
                        if (currentStationId === stationId) {
                            // Lấy status hiện tại từ selectedStation nếu có
                            var currentStatus = selectedStation && selectedStation.stationId === stationId ? selectedStation.status : null;
                            loadSpotsForReservation(stationId, currentStatus);
                        }
                    }
                });
                
                // Listen for spot status updates (when spot becomes occupied/available)
                signalRConnection.on('SpotStatusUpdated', function(spotId, status) {
                    console.log('SpotStatusUpdated received:', spotId, status);
                    
                    // Reload spots list if reservation modal is open
                    var reservationModal = document.getElementById('reservationModal');
                    if (reservationModal && reservationModal.classList.contains('show')) {
                        var stationId = document.getElementById('reservation-station-id').value;
                        if (stationId) {
                            // Reload spots để cập nhật trạng thái
                            var currentStatus = selectedStation && selectedStation.stationId === stationId ? selectedStation.status : null;
                            loadSpotsForReservation(stationId, currentStatus);
                        }
                    }
                });
                
                // Listen for session updates (when new charging session is created)
                signalRConnection.on('SessionUpdated', function(sessionId) {
                    console.log('SessionUpdated received:', sessionId);
                    
                    // Reload spots list if reservation modal is open
                    // Khi có session mới được tạo, spot sẽ chuyển sang trạng thái Occupied
                    var reservationModal = document.getElementById('reservationModal');
                    if (reservationModal && reservationModal.classList.contains('show')) {
                        var stationId = document.getElementById('reservation-station-id').value;
                        if (stationId) {
                            // Reload spots để cập nhật trạng thái (spot đã bị chiếm)
                            loadSpotsForReservation(stationId);
                        }
                    }
                });
                
                // Listen for station status updates (when admin toggles station on/off)
                signalRConnection.on('StationStatusUpdated', function(stationId, status, stationName) {
                    console.log('StationStatusUpdated received:', stationId, status, stationName);
                    
                    // Luôn gọi handleStationStatusUpdate để reload dữ liệu từ API
                    // Hàm này sẽ tự kiểm tra xem có đang xem trạm này không
                    handleStationStatusUpdate(stationId, status, stationName);
                    
                    // Cập nhật trong danh sách stations nếu có
                    updateStationInList(stationId, status);
                    
                    // Cập nhật modal đặt lịch nếu đang mở cho trạm này
                    var reservationModal = document.getElementById('reservationModal');
                    if (reservationModal && reservationModal.classList.contains('show')) {
                        var currentStationId = document.getElementById('reservation-station-id').value;
                        if (currentStationId === stationId) {
                            // Reload spots để cập nhật trạng thái
                            loadSpotsForReservation(stationId, status);
                        }
                    }
                });

                await signalRConnection.start();
                console.log('SignalR connected');
            } catch (err) {
                console.warn('Không thể kết nối SignalR', err);
            }
        }

        // Subscribe to station updates
        async function subscribeStationSignalR(stationId) {
            if (!signalRConnection || !stationId) return;

            try {
                // Unsubscribe from previous station if any
                if (subscribedStationId && subscribedStationId !== stationId) {
                    await signalRConnection.invoke('UnsubscribeStation', subscribedStationId);
                }

                // Subscribe to new station
                await signalRConnection.invoke('SubscribeStation', stationId);
                subscribedStationId = stationId;
            } catch (err) {
                console.warn('Không thể subscribe station SignalR', err);
            }
        }

        // Update station availability UI when receiving SignalR update
        async function updateStationAvailabilityUI(stationId, totalSpots, availableSpots) {
            if (!selectedStation || !selectedStation.stationId || selectedStation.stationId !== stationId) {
                return;
            }

            // Update station data
            selectedStation.totalSpots = totalSpots;
            selectedStation.availableSpots = availableSpots;
            selectedStation.connectorsText = availableSpots + '/' + totalSpots;

            // Update connectors display
            setInfoField('connectors', selectedStation.connectorsText);

            // Update status - kiểm tra station status trước
            if (selectedStation.status && selectedStation.status !== 'Active' && selectedStation.status !== 0) {
                // Station không Active (Inactive, Maintenance, Closed)
                selectedStation.statusText = 'Không khả dụng';
                selectedStation.statusClass = 'status-full';
                selectedStation.availableSpots = 0;
                selectedStation.connectorsText = '0/' + totalSpots;
                setInfoField('connectors', selectedStation.connectorsText);
            } else if (availableSpots === 0) {
                selectedStation.statusText = 'Đầy';
                selectedStation.statusClass = 'status-full';
            } else if (availableSpots < totalSpots / 2) {
                selectedStation.statusText = 'Đang bận';
                selectedStation.statusClass = 'status-busy';
            } else {
                selectedStation.statusText = 'Còn trống';
                selectedStation.statusClass = 'status-available';
            }

            setInfoField('status', selectedStation.statusText);
            if (mapInfoFields.status) {
                mapInfoFields.status.className = 'status-badge ' + selectedStation.statusClass;
            }
            
            // Cập nhật visibility của các nút đặt lịch và bắt đầu sạc
            updateReserveButtonVisibility();
        }

        // Xử lý cập nhật status của trạm khi nhận SignalR notification
        async function handleStationStatusUpdate(stationId, status, stationName) {
            console.log('handleStationStatusUpdate called:', stationId, status, stationName);
            
            // Reload lại dữ liệu trạm từ API để đảm bảo có dữ liệu mới nhất
            try {
                var response = await fetch('/api/ChargingStation/' + stationId, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    console.error('Failed to reload station data:', response.status);
                    return;
                }
                
                var stationData = await response.json();
                console.log('Reloaded station data:', stationData);
                
                // Cập nhật trong cache dbStations trước
                if (dbStations && dbStations.length > 0) {
                    var stationIndex = dbStations.findIndex(s => s.id === stationId);
                    if (stationIndex !== -1) {
                        dbStations[stationIndex] = stationData;
                    }
                }
                
                // Kiểm tra xem có đang xem trạm này không
                if (!selectedStation || !selectedStation.stationId || selectedStation.stationId !== stationId) {
                    // Không đang xem trạm này, chỉ cập nhật cache
                    return;
                }
                
                // Cập nhật selectedStation với dữ liệu mới
                selectedStation.status = stationData.status;
                selectedStation.totalSpots = stationData.totalSpots || 0;
                selectedStation.availableSpots = stationData.availableSpots || 0;
                
                // Kiểm tra xem trạm có bị tắt không
                var isInactive = stationData.status === 'Inactive' || stationData.status === 'Maintenance' || 
                                 stationData.status === 'Closed' || stationData.status === 1 || 
                                 stationData.status === 2 || stationData.status === 3;
                
                if (isInactive) {
                    // Trạm bị tắt - cập nhật UI và thông báo user
                    selectedStation.statusText = 'Không khả dụng';
                    selectedStation.statusClass = 'status-full';
                    selectedStation.availableSpots = 0;
                    selectedStation.connectorsText = '0/' + selectedStation.totalSpots;
                } else {
                    // Trạm đang hoạt động
                    selectedStation.connectorsText = selectedStation.availableSpots + '/' + selectedStation.totalSpots;
                    
                    // Cập nhật status text dựa trên available spots
                    if (selectedStation.availableSpots === 0) {
                        selectedStation.statusText = 'Đầy';
                        selectedStation.statusClass = 'status-full';
                    } else if (selectedStation.availableSpots < selectedStation.totalSpots / 2) {
                        selectedStation.statusText = 'Đang bận';
                        selectedStation.statusClass = 'status-busy';
                    } else {
                        selectedStation.statusText = 'Còn trống';
                        selectedStation.statusClass = 'status-available';
                    }
                }
                
                // Cập nhật UI
                setInfoField('connectors', selectedStation.connectorsText);
                setInfoField('status', selectedStation.statusText);
                if (mapInfoFields.status) {
                    mapInfoFields.status.className = 'status-badge ' + selectedStation.statusClass;
                }
                
                // Ẩn/hiện các nút đặt lịch và bắt đầu sạc
                updateReserveButtonVisibility();
                
                // Đóng modal đặt lịch nếu đang mở và trạm bị tắt
                if (isInactive) {
                    var reservationModal = document.getElementById('reservationModal');
                    if (reservationModal) {
                        var bsReservationModal = bootstrap.Modal.getInstance(reservationModal);
                        if (bsReservationModal) {
                            bsReservationModal.hide();
                        }
                    }
                    
                    // Đóng modal bắt đầu sạc nếu đang mở (nếu có)
                    var startChargingModal = document.getElementById('startChargingModal');
                    if (startChargingModal) {
                        var bsStartChargingModal = bootstrap.Modal.getInstance(startChargingModal);
                        if (bsStartChargingModal) {
                            bsStartChargingModal.hide();
                        }
                    }
                    
                    // Hiển thị thông báo cho user
                    showStationStatusNotification(stationName || stationData.name, false);
                } else {
                    // Thông báo trạm đã được bật lại
                    showStationStatusNotification(stationName || stationData.name, true);
                }
                
                // Cập nhật trong cache dbStations
                if (dbStations && dbStations.length > 0) {
                    var stationIndex = dbStations.findIndex(s => s.id === stationId);
                    if (stationIndex !== -1) {
                        dbStations[stationIndex] = stationData;
                    }
                }
                
            } catch (err) {
                console.error('Error reloading station data:', err);
            }
        }

        // Cập nhật trạm trong danh sách sidebar và popup marker
        async function updateStationInList(stationId, status) {
            // Tìm và cập nhật marker trên map nếu có
            if (window.stationMarkers && window.stationMarkers[stationId]) {
                var marker = window.stationMarkers[stationId];
                await updateMarkerPopupForStation(marker, stationId, status);
            }
            
            // Cập nhật tất cả serpMarkers có stationId tương ứng
            if (typeof serpMarkers !== 'undefined' && serpMarkers.length > 0) {
                for (var i = 0; i < serpMarkers.length; i++) {
                    var marker = serpMarkers[i];
                    if (marker && marker.stationData && marker.stationData.stationId === stationId) {
                        await updateMarkerPopupForStation(marker, stationId, status);
                    }
                }
            }
            
            // Cập nhật trong dbStations cache
            if (dbStations && dbStations.length > 0) {
                var stationIndex = dbStations.findIndex(s => s.id === stationId);
                if (stationIndex !== -1) {
                    dbStations[stationIndex].status = status;
                    if (status !== 'Active' && status !== 0) {
                        dbStations[stationIndex].availableSpots = 0;
                    }
                }
            }
        }

        // Cập nhật popup của marker khi status thay đổi
        async function updateMarkerPopupForStation(marker, stationId, status) {
            if (!marker) return;
            
            try {
                // Lấy thông tin marker hiện tại
                var stationData = marker.stationData || marker._originalStationDataRef?.data;
                if (!stationData) return;
                
                // Reload dữ liệu trạm từ API để có thông tin mới nhất
                var response = await fetch('/api/ChargingStation/' + stationId, {
                    credentials: 'include'
                });
                if (!response.ok) return;
                
                var stationInfo = await response.json();
                
                // Xác định status text và color
                var isInactive = status === 'Inactive' || status === 'Maintenance' || status === 'Closed' || 
                                status === 1 || status === 2 || status === 3;
                
                var statusText = 'Đang cập nhật';
                var statusColor = '#9CA3AF'; // Xám
                
                if (isInactive) {
                    statusText = 'Không khả dụng';
                    statusColor = '#EF4444'; // Đỏ
                } else if (stationInfo.availableSpots === 0) {
                    statusText = 'Đầy';
                    statusColor = '#EF4444'; // Đỏ
                } else if (stationInfo.availableSpots < (stationInfo.totalSpots || 0) / 2) {
                    statusText = 'Đang bận';
                    statusColor = '#FF9800'; // Cam
                } else {
                    statusText = 'Còn trống';
                    statusColor = '#10B981'; // Xanh lá
                }
                
                // Lấy thông tin từ marker
                var title = stationData.title || stationData.name || stationInfo.name || 'Trạm sạc';
                var address = stationData.address || stationInfo.address || '';
                var rating = stationData.rating || stationInfo.externalRating;
                var reviews = stationData.reviews || stationInfo.externalReviewCount;
                
                // Tạo popup mới với trạng thái cập nhật
                var updatedPopup = '<b>' + escapeHtml(title) + '</b>';
                if (address) updatedPopup += '<br/>' + escapeHtml(address);
                if (rating) {
                    updatedPopup += '<br/>Đánh giá: ' + escapeHtml(typeof rating === 'number' ? rating.toFixed(1) : rating);
                    if (reviews) updatedPopup += ' (' + escapeHtml(reviews) + ')';
                }
                updatedPopup += '<br/>Trạng thái: <span style="color:' + statusColor + ';font-weight:bold;">' + escapeHtml(statusText) + '</span>';
                
                // Cập nhật popup
                var isPopupOpen = false;
                try {
                    // Kiểm tra xem popup có đang mở không
                    if (marker._popup && marker._popup.isOpen) {
                        isPopupOpen = true;
                    }
                } catch (e) {
                    // Ignore error
                }
                
                if (marker.setPopupContent) {
                    marker.setPopupContent(updatedPopup);
                    // Nếu popup đang mở, mở lại để hiển thị nội dung mới
                    if (isPopupOpen) {
                        marker.openPopup();
                    }
                } else if (marker.bindPopup) {
                    marker.bindPopup(updatedPopup, { autoClose: false, closeOnClick: false, autoPan: false });
                    if (isPopupOpen) {
                        marker.openPopup();
                    }
                }
                
                // Cập nhật stationData
                if (stationData) {
                    stationData.status = status;
                    stationData.statusText = statusText;
                    stationData.statusClass = isInactive ? 'status-full' : (statusText === 'Đầy' ? 'status-full' : (statusText === 'Đang bận' ? 'status-busy' : 'status-available'));
                    stationData.availableSpots = isInactive ? 0 : (stationInfo.availableSpots || 0);
                    stationData.totalSpots = stationInfo.totalSpots || 0;
                }
                
            } catch (err) {
                console.error('Error updating marker popup:', err);
            }
        }

        // Hiển thị thông báo khi trạm thay đổi status
        function showStationStatusNotification(stationName, isActivated) {
            // Tạo hoặc lấy container thông báo
            var notificationContainer = document.getElementById('station-status-notification');
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'station-status-notification';
                notificationContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 400px;';
                document.body.appendChild(notificationContainer);
            }
            
            // Tạo thông báo
            var alertClass = isActivated ? 'alert-success' : 'alert-warning';
            var message = isActivated 
                ? 'Trạm "' + stationName + '" đã được bật lại và sẵn sàng sử dụng.'
                : 'Trạm "' + stationName + '" đã bị tắt. Bạn không thể đặt lịch hoặc bắt đầu sạc tại trạm này.';
            
            var alertDiv = document.createElement('div');
            alertDiv.className = 'alert ' + alertClass + ' alert-dismissible fade show';
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = '<strong>' + (isActivated ? 'Thông báo' : 'Cảnh báo') + ':</strong> ' + message + 
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
            
            notificationContainer.innerHTML = '';
            notificationContainer.appendChild(alertDiv);
            
            // Tự động ẩn sau 5 giây
            setTimeout(function() {
                if (alertDiv && alertDiv.parentNode) {
                    var bsAlert = new bootstrap.Alert(alertDiv);
                    bsAlert.close();
                }
            }, 5000);
        }

        // Refresh danh sách stations khi nhận SignalR update về availability
        async function refreshStationsListForAvailabilityUpdate(stationId, totalSpots, availableSpots) {
            if (!mapInstance) return;
            
            try {
                var center = mapInstance.getCenter();
                if (!center) return;
                
                // Lấy các filter hiện tại
                var connectorTypeEl = document.getElementById('filter-connector-type');
                var statusFilterEl = document.getElementById('filter-status');
                var sortByEl = document.getElementById('filter-sort');
                var radiusEl = document.getElementById('filter-radius');
                
                if (!connectorTypeEl || !statusFilterEl || !sortByEl || !radiusEl) {
                    return;
                }
                
                var connectorType = connectorTypeEl.value;
                var statusFilter = statusFilterEl.value;
                var sortBy = sortByEl.value;
                var radius = parseFloat(radiusEl.value) || 10;
                
                // Chỉ refresh nếu đang hiển thị danh sách từ API (không phải đang search)
                var searchInput = document.querySelector('.search-input');
                if (searchInput && searchInput.value.trim()) {
                    // Đang search, không refresh
                    return;
                }
                
                // Kiểm tra xem có đang search không
                if (typeof window.isSearching !== 'undefined' && window.isSearching) {
                    return;
                }
                
                // Gọi API để lấy danh sách stations mới nhất
                var url = '/api/ChargingStation/nearest?lat=' + center.lat + '&lng=' + center.lng + '&radiusKm=' + radius;
                if (connectorType) {
                    url += '&connectorType=' + encodeURIComponent(connectorType);
                }
                
                var response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.warn('Failed to refresh stations list:', response.status);
                    return;
                }
                
                var stations = await response.json();
                if (!Array.isArray(stations)) {
                    return;
                }
                
                // Filter by status
                if (statusFilter === 'Available') {
                    stations = stations.filter(function(s) { return s.availableSpots > 0; });
                } else if (statusFilter === 'Occupied') {
                    stations = stations.filter(function(s) { return s.availableSpots > 0 && s.availableSpots < s.totalSpots; });
                } else if (statusFilter === 'Full') {
                    stations = stations.filter(function(s) { return s.availableSpots === 0; });
                }
                
                // Sort
                if (sortBy === 'distance') {
                    stations.sort(function(a, b) { return (a.distanceKm || 0) - (b.distanceKm || 0); });
                } else if (sortBy === 'rating') {
                    stations.sort(function(a, b) { return (b.externalRating || 0) - (a.externalRating || 0); });
                } else if (sortBy === 'name') {
                    stations.sort(function(a, b) { return a.name.localeCompare(b.name); });
                }
                
                // Cập nhật marker data và sidebar
                if (typeof clearSerpMarkers === 'function') {
                    clearSerpMarkers();
                }
                
                var normalized = stations.map(function(s) {
                    var marker = null;
                    if (typeof addSerpMarker === 'function') {
                        marker = addSerpMarker(
                            parseFloat(s.latitude),
                            parseFloat(s.longitude),
                            s.name,
                            s.address,
                            s.externalRating,
                            s.externalReviewCount
                        );
                    }
                    
                    if (marker) {
                        marker.stationData = {
                            title: s.name,
                            address: s.address,
                            latitude: parseFloat(s.latitude),
                            longitude: parseFloat(s.longitude),
                            stationId: s.id,
                            availableSpots: s.availableSpots,
                            totalSpots: s.totalSpots,
                            distanceKm: s.distanceKm,
                            distanceText: s.distanceKm ? s.distanceKm.toFixed(1) + ' km' : '--'
                        };
                    }
                    
                    return {
                        title: s.name,
                        address: s.address,
                        latitude: parseFloat(s.latitude),
                        longitude: parseFloat(s.longitude),
                        rating: s.externalRating,
                        reviews: s.externalReviewCount,
                        stationId: s.id,
                        availableSpots: s.availableSpots,
                        totalSpots: s.totalSpots,
                        distanceKm: s.distanceKm,
                        distanceText: s.distanceKm ? s.distanceKm.toFixed(1) + ' km' : '--'
                    };
                });
                
                // Cập nhật sidebar với dữ liệu mới
                if (typeof updateSidebarWithSerpResults === 'function') {
                    updateSidebarWithSerpResults(normalized, center);
                }
                
                // Cập nhật lại selectedStation nếu đang được chọn
                if (selectedStation && selectedStation.stationId === stationId) {
                    var updatedStation = normalized.find(function(s) { return s.stationId === stationId; });
                    if (updatedStation) {
                        selectedStation.availableSpots = updatedStation.availableSpots;
                        selectedStation.totalSpots = updatedStation.totalSpots;
                        selectedStation.connectorsText = updatedStation.availableSpots + '/' + updatedStation.totalSpots;
                    }
                }
            } catch (error) {
                console.error('Error refreshing stations list:', error);
            }
        }

        // Kiểm tra user đã đăng nhập chưa
        function checkAuthentication() {
            // Check bằng cách gọi API Vehicle (cần auth)
            fetch('/api/Vehicle', {
                credentials: 'include'
            }).then(r => {
                isUserAuthenticated = r.ok || r.status === 401; // 401 cũng có nghĩa là đã có session nhưng chưa đủ quyền
                if (r.status === 401) {
                    // Có thể là chưa đăng nhập hoặc session hết hạn
                    isUserAuthenticated = false;
                }
                updateReserveButtonVisibility();
            }).catch(() => {
                isUserAuthenticated = false;
                updateReserveButtonVisibility();
            });
        }

        function updateReserveButtonVisibility() {
            var btnReserve = document.getElementById('btn-reserve');
            var btnStartCharging = document.getElementById('btn-start-charging');
            var btnDirection = document.getElementById('btn-direction');
            
            // Kiểm tra xem trạm có dữ liệu từ admin không (có stationId)
            var hasAdminData = selectedStation && selectedStation.stationId;
            
            // Kiểm tra station status - chỉ hiển thị nút khi station Active
            var isStationActive = false;
            if (selectedStation) {
                var status = selectedStation.status;
                // Xử lý cả string và number
                if (status === null || status === undefined) {
                    isStationActive = true; // Mặc định là Active nếu không có status
                } else if (typeof status === 'string') {
                    isStationActive = status === 'Active';
                } else if (typeof status === 'number') {
                    isStationActive = status === 0; // 0 = Active
                }
            }
            var hasAvailableSpots = selectedStation && selectedStation.availableSpots > 0;
            
            if (btnReserve) {
                // Chỉ hiển thị nút "Đặt lịch" khi:
                // 1. User đã đăng nhập
                // 2. Trạm có dữ liệu từ admin (có stationId) - QUAN TRỌNG: không hiện nếu chỉ có dữ liệu Google Maps
                // 3. Station Active
                // 4. Có available spots
                var shouldShowReserve = isUserAuthenticated && hasAdminData && 
                    isStationActive && hasAvailableSpots;
                btnReserve.style.display = shouldShowReserve ? 'flex' : 'none';
            }
            
            if (btnStartCharging) {
                // Chỉ hiển thị nút "Bắt đầu sạc" khi:
                // 1. User đã đăng nhập
                // 2. Trạm có dữ liệu từ admin (có stationId)
                // 3. Station Active
                // 4. Có available spots
                var shouldShowStart = isUserAuthenticated && hasAdminData && 
                    isStationActive && hasAvailableSpots;
                btnStartCharging.style.display = shouldShowStart ? 'flex' : 'none';
            }
            
            // Nút "Chỉ đường" luôn hiển thị nếu có selectedStation (có thể là từ Google Maps hoặc admin)
            if (btnDirection) {
                btnDirection.style.display = selectedStation ? 'flex' : 'none';
            }
        }

        // Tìm trạm trong database match với trạm từ SerpApi
        async function findMatchingStation(serpStation) {
            if (!serpStation || !serpStation.latitude || !serpStation.longitude) return null;
            
            // Load danh sách trạm từ database nếu chưa có
            if (dbStations.length === 0) {
                try {
                    var response = await fetch('/api/ChargingStation', {
                        credentials: 'include'
                    });
                    if (response.ok) {
                        dbStations = await response.json();
                    }
                } catch (err) {
                    console.error('Error loading stations:', err);
                }
            }

            // Tìm trạm match theo tọa độ (trong phạm vi 100m)
            var bestMatch = null;
            var minDistance = 0.1; // 100m

            for (var i = 0; i < dbStations.length; i++) {
                var dbStation = dbStations[i];
                if (!dbStation.latitude || !dbStation.longitude) continue;

                var distance = calculateDistanceKm(
                    serpStation.latitude, serpStation.longitude,
                    dbStation.latitude, dbStation.longitude
                );

                if (distance !== null && distance < minDistance) {
                    minDistance = distance;
                    bestMatch = dbStation;
                }
            }

            return bestMatch;
        }

        // Làm giàu thông tin trạm với dữ liệu từ database
        async function enrichStationWithDbData(station) {
            if (!station) return station;

            var dbStation = await findMatchingStation(station);
            if (dbStation) {
                station.stationId = dbStation.id;
                station.totalSpots = dbStation.totalSpots || 0;
                station.availableSpots = dbStation.availableSpots || 0;
                station.connectorsText = station.availableSpots + '/' + station.totalSpots;
                station.status = dbStation.status || 'Active'; // Lưu station status
                
                // Xác định trạng thái - kiểm tra station status trước
                if (dbStation.status && dbStation.status !== 'Active' && dbStation.status !== 0) {
                    // Station không Active (Inactive, Maintenance, Closed)
                    station.statusText = 'Không khả dụng';
                    station.statusClass = 'status-full';
                    station.availableSpots = 0; // Đảm bảo availableSpots = 0
                    station.connectorsText = '0/' + station.totalSpots;
                } else if (station.availableSpots === 0) {
                    station.statusText = 'Đầy';
                    station.statusClass = 'status-full';
                } else if (station.availableSpots < station.totalSpots / 2) {
                    station.statusText = 'Đang bận';
                    station.statusClass = 'status-busy';
                } else {
                    station.statusText = 'Còn trống';
                    station.statusClass = 'status-available';
                }

                // Loại sạc (lấy từ DTO)
                if (dbStation.connectorType) {
                    station.chargerType = dbStation.connectorType;
                    station.connectorType = dbStation.connectorType;
                }

                // Giá sạc (lấy từ DTO)
                if (dbStation.pricePerKwh) {
                    station.priceText = formatPrice(dbStation.pricePerKwh);
                }
            } else {
                // Nếu không tìm thấy trong DB, dùng thông tin mặc định
                station.statusText = 'Đang cập nhật';
                station.statusClass = 'status-available';
            }

            return station;
        }

        function formatPrice(price) {
            if (!price) return '--';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(price) + '/kWh';
        }

        function captureSidebarState() {
            return {
                listHtml: stationListEl ? stationListEl.innerHTML : '',
                countText: stationCountTextEl ? stationCountTextEl.textContent : '',
                total: statTotalEl ? statTotalEl.textContent : '',
                rated: statRatedEl ? statRatedEl.textContent : '',
                average: statAverageEl ? statAverageEl.textContent : ''
            };
        }

        function applySidebarState(state) {
            if (!state) return;
            if (stationListEl) stationListEl.innerHTML = state.listHtml || '';
            if (stationCountTextEl) stationCountTextEl.textContent = state.countText || '';
            if (statTotalEl) statTotalEl.textContent = state.total || '0';
            if (statRatedEl) statRatedEl.textContent = state.rated || '0';
            if (statAverageEl) statAverageEl.textContent = state.average || '--';
        }

        var defaultSidebarState = captureSidebarState();
        var lastSidebarState = defaultSidebarState;

        function setSidebarLoading(customMessage) {
            var message = customMessage || 'Đang tìm kiếm...';
            if (stationCountTextEl) stationCountTextEl.textContent = message;
            if (stationListEl) {
                stationListEl.innerHTML = '<div class="station-empty" style="color: #666;"><svg style="display: inline-block; vertical-align: middle; margin-right: 8px;" width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" stroke="#666" stroke-width="2" fill="none" stroke-dasharray="12.5 12.5" transform="rotate(0 10 10)"><animateTransform attributeName="transform" type="rotate" from="0 10 10" to="360 10 10" dur="1s" repeatCount="indefinite"/></circle></svg>' + message + '</div>';
            }
        }

        function setInfoField(field, value) {
            if (!mapInfoFields || !mapInfoFields[field]) return;
            mapInfoFields[field].textContent = value || '--';
        }

        function closeMapInfoCard() {
            resetStationDetails();
        }

        async function resetStationDetails() {
            // Unsubscribe from SignalR if subscribed
            if (signalRConnection && subscribedStationId) {
                try {
                    await signalRConnection.invoke('UnsubscribeStation', subscribedStationId);
                    subscribedStationId = null;
                } catch (err) {
                    console.warn('Không thể unsubscribe station SignalR', err);
                }
            }

            selectedStation = null;
            if (mapInfoCard) {
                mapInfoCard.style.display = 'none';
                setInfoField('title', 'Trạm sạc');
                setInfoField('address', 'Đang cập nhật');
                setInfoField('status', 'Đang cập nhật');
                if (mapInfoFields.status) {
                    mapInfoFields.status.className = 'status-badge status-available';
                }
                setInfoField('connectors', '--');
                setInfoField('distance', '--');
                setInfoField('chargerType', '--');
                setInfoField('rating', '--');
                setInfoField('price', '--');
            }
        }

        async function showStationDetails(station) {
            if (!station) {
                console.log('showStationDetails: station is null/undefined');
                return;
            }
            
            // Re-query mapInfoCard in case it wasn't found initially
            if (!mapInfoCard) {
                mapInfoCard = document.querySelector('.map-info-card');
            }
            
            if (!mapInfoCard) {
                console.error('mapInfoCard not found');
                return;
            }

            console.log('showStationDetails: displaying card for station:', station);
            // Làm giàu thông tin với dữ liệu từ database
            station = await enrichStationWithDbData(station);
            selectedStation = station;
            mapInfoCard.style.display = 'block';
            console.log('showStationDetails: card display set to block');

            // Subscribe to SignalR updates for this station
            if (station.stationId) {
                await subscribeStationSignalR(station.stationId);
            }

            setInfoField('title', station.title || station.name || 'Trạm sạc');
            setInfoField('address', station.address || 'Đang cập nhật');
            setInfoField('status', station.statusText || 'Đang cập nhật');

            var connectorDisplay = station.connectorsText || station.availableText;
            if (!connectorDisplay && typeof station.availableSpots === 'number' && typeof station.totalSpots === 'number') {
                connectorDisplay = station.availableSpots + '/' + station.totalSpots;
            }
            setInfoField('connectors', connectorDisplay || '--');

            setInfoField('distance', station.distanceText || '--');
            setInfoField('chargerType', station.chargerType || station.connectorType || '--');
            setInfoField('rating', station.ratingText || 'Chưa có đánh giá');
            setInfoField('price', station.priceText || '--');

            if (mapInfoFields.status) {
                mapInfoFields.status.className = 'status-badge ' + (station.statusClass || 'status-available');
            }

            updateReserveButtonVisibility();
        }

        function escapeHtml(str) {
            if (typeof str !== 'string') {
                if (str === null || str === undefined) return '';
                str = String(str);
            }
            return str.replace(/[&<>"']/g, function (m) {
                switch (m) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case '\'': return '&#39;';
                    default: return m;
                }
            });
        }

        function calculateDistanceKm(lat1, lng1, lat2, lng2) {
            if ([lat1, lng1, lat2, lng2].some(function(v) { return typeof v !== 'number' || isNaN(v); })) {
                return null;
            }
            var R = 6371; // km
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var distance = R * c;
            return Math.round(distance * 10) / 10;
        }

        function updateSidebarWithSerpResults(list, center) {
            if (!stationListEl) {
                return;
            }
            var searchInput = document.querySelector('.search-input');

            var total = Array.isArray(list) ? list.length : 0;
            var ratedCount = 0;
            var ratingSum = 0;

            if (!Array.isArray(list) || list.length === 0) {
                // Chỉ hiển thị "không tìm thấy" nếu không phải đang trong quá trình tìm kiếm khác
                var isSearching = typeof window.isSearching !== 'undefined' ? window.isSearching : false;
                var searchInput = document.querySelector('.search-input');
                if (!isSearching || (searchInput && !searchInput.value.trim())) {
                    stationListEl.innerHTML = '<div class="station-empty">Không tìm thấy trạm sạc trong khu vực này.</div>';
                    if (stationCountTextEl) stationCountTextEl.textContent = '0 trạm sạc được tìm thấy';
                    if (statTotalEl) statTotalEl.textContent = '0';
                    if (statRatedEl) statRatedEl.textContent = '0';
                    if (statAverageEl) statAverageEl.textContent = '--';
                    lastSidebarState = captureSidebarState();
                    resetStationDetails();
                }
                return;
            }

            var cardsHtml = '';
            for (var i = 0; i < list.length; i++) {
                var item = list[i] || {};
                var title = item.title || item.Title || 'Trạm sạc';
                var address = item.address || item.Address || 'Địa chỉ chưa cập nhật';
                var rating = item.rating != null ? item.rating : item.Rating;
                var reviews = item.reviews != null ? item.reviews : item.Reviews;
                var lat = item.latitude != null ? item.latitude : item.Latitude;
                var lng = item.longitude != null ? item.longitude : item.Longitude;
                if (typeof rating === 'string') rating = parseFloat(rating);
                if (typeof reviews === 'string') reviews = parseInt(reviews, 10);
                if (typeof lat === 'string') lat = parseFloat(lat);
                if (typeof lng === 'string') lng = parseFloat(lng);

                if (typeof rating === 'number' && !isNaN(rating)) {
                    ratedCount++;
                    ratingSum += rating;
                } else {
                    rating = null;
                }

                var distanceKm = null;
                if (center && typeof center.lat === 'number' && typeof center.lng === 'number') {
                    distanceKm = calculateDistanceKm(center.lat, center.lng, lat, lng);
                }

                var ratingText = rating ? rating.toFixed(1) + (reviews ? ' (' + reviews + ')' : '') : 'Chưa có đánh giá';
                var distanceText = distanceKm != null ? distanceKm + ' km' : '--';

                item.distanceKm = distanceKm;
                item.distanceText = distanceText;
                item.ratingValue = rating;
                item.ratingText = ratingText;
                item.reviewCount = reviews;
                item.connectorsText = item.connectorsText || '--';
                item.chargerType = item.chargerType || '--';
                item.priceText = item.priceText || '--';
                item.statusText = item.statusText || 'Đang cập nhật';
                item.statusClass = item.statusClass || 'status-available';

                cardsHtml +=
                    '<div class="station-card station-serp-card" data-marker-index="' + i + '">' +
                        '<div class="station-card-header">' +
                            '<div class="station-info">' +
                                '<h3 class="station-name">' + escapeHtml(title) + '</h3>' +
                                '<div class="station-address">' +
                                    '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                        '<path d="M8 2C5.24 2 3 4.24 3 7C3 10.5 8 14 8 14C8 14 13 10.5 13 7C13 4.24 10.76 2 8 2Z" stroke="#4A5565" stroke-width="1.5"/>' +
                                        '<circle cx="8" cy="7" r="2" stroke="#4A5565" stroke-width="1.5"/>' +
                                    '</svg>' +
                                    '<span>' + escapeHtml(address) + '</span>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="station-details">' +
                            '<div class="detail-left">' +
                                '<div class="detail-item">' +
                                    '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                        '<path d="M8 2L10 6L14 7L11 10L11.5 14L8 12L4.5 14L5 10L2 7L6 6L8 2Z" stroke="#364153" stroke-width="1.5" stroke-linejoin="round"/>' +
                                    '</svg>' +
                                    '<span>' + escapeHtml(ratingText) + '</span>' +
                                '</div>' +
                            '</div>' +
                            '<div class="detail-right">' +
                                '<span class="distance">' + escapeHtml(distanceText) + '</span>' +
                                '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                                    '<path d="M8 2V14M8 2L5 5M8 2L11 5M8 14L5 11M8 14L11 11" stroke="#6A7282" stroke-width="1.5" stroke-linecap="round"/>' +
                                '</svg>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
            }

            stationListEl.innerHTML = cardsHtml;

            if (stationCountTextEl) stationCountTextEl.textContent = total + ' trạm sạc được tìm thấy';
            if (statTotalEl) statTotalEl.textContent = total.toString();
            if (statRatedEl) statRatedEl.textContent = ratedCount.toString();
            if (statAverageEl) statAverageEl.textContent = ratedCount > 0 ? (ratingSum / ratedCount).toFixed(1) : '--';

            var cards = stationListEl.querySelectorAll('.station-serp-card');
            Array.prototype.forEach.call(cards, function(card) {
                card.addEventListener('click', function() {
                    var idx = parseInt(card.getAttribute('data-marker-index'), 10);
                    if (!isNaN(idx) && serpMarkers[idx]) {
                        var marker = serpMarkers[idx];
                        var latLng = marker.getLatLng();
                        if (latLng) {
                            var targetZoom = mapInstance.getZoom();
                            if (!targetZoom || targetZoom < 15) targetZoom = 15;
                            mapInstance.setView(latLng, targetZoom);
                        }
                        marker.openPopup();
                    }
                    var station = Array.isArray(list) ? list[idx] : null;
                    if (station) {
                        showStationDetails(station);
                    }
                });
            });

            lastSidebarState = captureSidebarState();
        }
        
        setTimeout(function() {
            if (typeof L !== 'undefined') {
                var placeholder = document.querySelector('.map-placeholder');
                if (placeholder) placeholder.style.display = 'none';
                
                var mapEl = document.getElementById('map');
                if (mapEl) {
                    // Helper: add user marker and center
                    // Function to update user location
                    // Hàm lưu vị trí vào localStorage
                    function saveLocationToCache(lat, lng, accuracy) {
                        try {
                            var locationData = {
                                lat: lat,
                                lng: lng,
                                accuracy: accuracy || null,
                                timestamp: Date.now()
                            };
                            localStorage.setItem('userLocation', JSON.stringify(locationData));
                        } catch (e) {
                            console.warn('Không thể lưu vị trí vào cache:', e);
                        }
                    }

                    // Hàm đọc vị trí từ localStorage
                    function getCachedLocation(maxAge) {
                        maxAge = maxAge || 3600000; // Mặc định 1 giờ
                        try {
                            var cached = localStorage.getItem('userLocation');
                            if (!cached) return null;
                            
                            var locationData = JSON.parse(cached);
                            var age = Date.now() - locationData.timestamp;
                            
                            if (age > maxAge) {
                                localStorage.removeItem('userLocation');
                                return null;
                            }
                            
                            return {
                                lat: locationData.lat,
                                lng: locationData.lng,
                                accuracy: locationData.accuracy,
                                age: age
                            };
                        } catch (e) {
                            console.warn('Không thể đọc vị trí từ cache:', e);
                            return null;
                        }
                    }

                    function updateUserLocation(lat, lng, showPopup) {
                        showPopup = showPopup || false;
                        
                        // Remove old marker if exists
                        if (currentUserMarker) {
                            mapInstance.removeLayer(currentUserMarker);
                        }
                        
                        // Add new marker at current location
                        var userIcon = L.divIcon({
                            className: 'custom-marker',
                            html: '<div style="background:#155DFC;width:20px;height:20px;border-radius:50%;border:2px solid white;"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });
                        currentUserMarker = L.marker([lat, lng], {icon: userIcon}).addTo(mapInstance);
                        currentUserMarker.bindPopup('<b>Vị trí của bạn</b>');
                        
                        if (showPopup) {
                            currentUserMarker.openPopup();
                        }
                        
                        // Center map on user location
                        mapInstance.setView([lat, lng], 15);
                    }

                    function fetchApproximateLocation() {
                        // Thử nhiều dịch vụ IP geolocation để tăng độ tin cậy
                        var services = [
                            { url: 'https://ipapi.co/json/', parser: function(data) {
                                return { lat: parseFloat(data.latitude), lng: parseFloat(data.longitude) };
                            }},
                            { url: 'https://ip-api.com/json/', parser: function(data) {
                                return { lat: parseFloat(data.lat), lng: parseFloat(data.lon) };
                            }}
                        ];
                        
                        function tryService(index) {
                            if (index >= services.length) {
                                throw new Error('Tất cả dịch vụ IP location đều thất bại');
                            }
                            
                            var service = services[index];
                            var controller = new AbortController();
                            var timeoutId = setTimeout(function() {
                                controller.abort();
                            }, 5000);
                            
                            return fetch(service.url, { 
                                signal: controller.signal
                            })
                            .then(function(response) {
                                clearTimeout(timeoutId);
                                if (!response.ok) {
                                    throw new Error('Service ' + index + ' failed');
                                }
                                return response.json();
                            })
                            .then(function(data) {
                                var coords = service.parser(data);
                                var lat = coords.lat;
                                var lng = coords.lng;
                                
                                if (isNaN(lat) || isNaN(lng)) {
                                    throw new Error('Invalid coordinates');
                                }
                                
                                // Kiểm tra tọa độ hợp lệ
                                if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                                    throw new Error('Coordinates out of range');
                                }
                                
                                return { lat: lat, lng: lng, source: 'ip' };
                            })
                            .catch(function(error) {
                                clearTimeout(timeoutId);
                                // Thử dịch vụ tiếp theo
                                if (index < services.length - 1) {
                                    return tryService(index + 1);
                                }
                                throw error;
                            });
                        }
                        
                        return tryService(0);
                    }

                    function useApproximateLocation(options) {
                        options = options || {};
                        var showPopup = !!options.showPopup;
                        var notify = !!options.notify;
                        var messagePrefix = options.messagePrefix || '';
                        var onFinally = typeof options.onFinally === 'function' ? options.onFinally : function () {};

                        // Thử dùng vị trí đã cache trước
                        var cached = getCachedLocation(7200000); // 2 giờ
                        if (cached && cached.accuracy && cached.accuracy < 1000) {
                            // Nếu có vị trí GPS đã cache với độ chính xác tốt, dùng nó
                            if (!mapInstance) {
                                mapInstance = L.map('map').setView([cached.lat, cached.lng], 15);
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    maxZoom: 19
                                }).addTo(mapInstance);
                                setTimeout(function() {
                                    if (mapInstance.invalidateSize) mapInstance.invalidateSize();
                                }, 300);
                            }
                            updateUserLocation(cached.lat, cached.lng, showPopup);
                            try {
                                setSidebarLoading('Đang tìm trạm sạc gần bạn...');
                                searchNearbyStations(captureSidebarState()).catch(function(){ /* ignore */ });
                            } catch (e) {}
                            if (notify) {
                                var text = messagePrefix ? messagePrefix + ' ' : '';
                                alert(text + 'Đang sử dụng vị trí đã lưu trước đó.');
                            }
                            onFinally();
                            return;
                        }

                        var finallyCalled = false;
                        fetchApproximateLocation()
                            .then(function(coords) {
                                // Initialize map if not ready
                                if (!mapInstance) {
                                    mapInstance = L.map('map').setView([coords.lat, coords.lng], 15);
                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                        maxZoom: 19
                                    }).addTo(mapInstance);
                                    setTimeout(function() {
                                        if (mapInstance.invalidateSize) mapInstance.invalidateSize();
                                    }, 300);
                                }
                                updateUserLocation(coords.lat, coords.lng, showPopup);
                                // Lưu vị trí IP vào cache (với accuracy cao để đánh dấu là IP-based)
                                saveLocationToCache(coords.lat, coords.lng, 5000);
                                // Auto search nearby after location is ready
                                try {
                                    setSidebarLoading('Đang tìm trạm sạc gần bạn...');
                                    searchNearbyStations(captureSidebarState()).catch(function(){ /* ignore */ });
                                } catch (e) {}
                                if (notify) {
                                    var text = messagePrefix ? messagePrefix + ' ' : '';
                                    alert(text + 'Đang sử dụng vị trí ước lượng gần đúng dựa trên IP của bạn.');
                                }
                                if (!finallyCalled) {
                                    finallyCalled = true;
                                    onFinally();
                                }
                            })
                            .catch(function() {
                                // Nếu IP location thất bại, thử dùng cache cũ
                                var oldCache = getCachedLocation(86400000); // 24 giờ
                                if (oldCache) {
                                    if (!mapInstance) {
                                        mapInstance = L.map('map').setView([oldCache.lat, oldCache.lng], 15);
                                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                            maxZoom: 19
                                        }).addTo(mapInstance);
                                        setTimeout(function() {
                                            if (mapInstance.invalidateSize) mapInstance.invalidateSize();
                                        }, 300);
                                    }
                                    updateUserLocation(oldCache.lat, oldCache.lng, showPopup);
                                    try {
                                        setSidebarLoading('Đang tìm trạm sạc gần bạn...');
                                        searchNearbyStations(captureSidebarState()).catch(function(){ /* ignore */ });
                                    } catch (e) {}
                                    if (notify) {
                                        var text = messagePrefix ? messagePrefix + ' ' : '';
                                        alert(text + 'Đang sử dụng vị trí đã lưu trước đó (có thể không chính xác).');
                                    }
                                    if (!finallyCalled) {
                                        finallyCalled = true;
                                        onFinally();
                                    }
                                    return;
                                }
                                
                                if (notify) {
                                    var errorText = messagePrefix ? messagePrefix + ' ' : '';
                                    alert(errorText + 'Không thể xác định vị trí của bạn. Vui lòng thử lại sau.');
                                }
                                if (!finallyCalled) {
                                    finallyCalled = true;
                                    onFinally();
                                }
                            });
                    }

                    function requestUserLocation(options) {
                        options = options || {};
                        var showPopup = !!options.showPopup;
                        var notify = !!options.notify;
                        var retryCount = options.retryCount || 0;
                        var maxRetries = options.maxRetries || 2;
                        var onFinally = typeof options.onFinally === 'function' ? options.onFinally : function () {};

                        if (!navigator.geolocation) {
                            useApproximateLocation({
                                showPopup: showPopup,
                                notify: notify,
                                messagePrefix: 'Trình duyệt của bạn không hỗ trợ định vị trực tiếp.',
                                onFinally: onFinally
                            });
                            return;
                        }

                        // Thử dùng vị trí đã cache nếu không phải retry
                        if (retryCount === 0) {
                            var cached = getCachedLocation(60000); // 1 phút
                            if (cached && cached.accuracy && cached.accuracy < 100) {
                                // Có vị trí GPS cache rất chính xác (< 100m), dùng luôn
                                if (!mapInstance) {
                                    mapInstance = L.map('map').setView([cached.lat, cached.lng], 15);
                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                        maxZoom: 19
                                    }).addTo(mapInstance);
                                    setTimeout(function() {
                                        if (mapInstance.invalidateSize) mapInstance.invalidateSize();
                                    }, 300);
                                }
                                updateUserLocation(cached.lat, cached.lng, showPopup);
                                try {
                                    setSidebarLoading('Đang tìm trạm sạc gần bạn...');
                                    searchNearbyStations(captureSidebarState()).catch(function(){ /* ignore */ });
                                } catch (e) {}
                                onFinally();
                                return;
                            }
                        }

                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                var lat = position.coords.latitude;
                                var lng = position.coords.longitude;
                                var accuracy = position.coords.accuracy || null;
                                
                                // Kiểm tra độ chính xác
                                var isAccurate = !accuracy || accuracy <= 100; // Chấp nhận nếu accuracy <= 100m
                                var isAcceptable = !accuracy || accuracy <= 1000; // Chấp nhận được nếu <= 1km
                                
                                // Nếu không chính xác lắm và chưa retry hết, thử lại
                                if (!isAcceptable && retryCount < maxRetries) {
                                    setTimeout(function() {
                                        requestUserLocation({
                                            showPopup: showPopup,
                                            notify: false, // Không thông báo khi retry
                                            retryCount: retryCount + 1,
                                            maxRetries: maxRetries,
                                            onFinally: onFinally
                                        });
                                    }, 1000 * (retryCount + 1)); // Exponential backoff
                                    return;
                                }
                                
                                // Lưu vị trí vào cache
                                saveLocationToCache(lat, lng, accuracy);
                                
                                // Cảnh báo nếu độ chính xác không tốt
                                if (notify && accuracy && accuracy > 100) {
                                    var accuracyText = accuracy > 1000 
                                        ? 'Vị trí có thể không chính xác (sai lệch khoảng ' + Math.round(accuracy) + 'm).'
                                        : 'Vị trí có độ chính xác trung bình (sai lệch khoảng ' + Math.round(accuracy) + 'm).';
                                    console.warn(accuracyText);
                                }
                                
                                // Initialize map if not ready
                                if (!mapInstance) {
                                    mapInstance = L.map('map').setView([lat, lng], 15);
                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                        maxZoom: 19
                                    }).addTo(mapInstance);
                                    setTimeout(function() {
                                        if (mapInstance.invalidateSize) mapInstance.invalidateSize();
                                    }, 300);
                                }
                                updateUserLocation(lat, lng, showPopup);
                                // Auto search nearby after location is ready
                                try {
                                    setSidebarLoading('Đang tìm trạm sạc gần bạn...');
                                    searchNearbyStations(captureSidebarState()).catch(function(){ /* ignore */ });
                                } catch (e) {}
                                onFinally();
                            },
                            function(error) {
                                var errorMessage = 'Không thể lấy vị trí của bạn.';
                                var shouldRetry = false;
                                
                                if (error && error.code === 1) {
                                    errorMessage = 'Bạn đã từ chối quyền truy cập vị trí.';
                                } else if (error && error.code === 2) {
                                    errorMessage = 'Vị trí hiện không khả dụng.';
                                    shouldRetry = retryCount < maxRetries; // Retry nếu lỗi tạm thời
                                } else if (error && error.code === 3) {
                                    errorMessage = 'Yêu cầu lấy vị trí bị hết thời gian.';
                                    shouldRetry = retryCount < maxRetries; // Retry nếu timeout
                                }

                                // Thử lại nếu có thể
                                if (shouldRetry) {
                                    setTimeout(function() {
                                        requestUserLocation({
                                            showPopup: showPopup,
                                            notify: false,
                                            retryCount: retryCount + 1,
                                            maxRetries: maxRetries,
                                            onFinally: onFinally
                                        });
                                    }, 2000 * (retryCount + 1)); // Exponential backoff
                                    return;
                                }

                                // Nếu không thể retry, dùng IP location
                                useApproximateLocation({
                                    showPopup: showPopup,
                                    notify: notify,
                                    messagePrefix: errorMessage,
                                    onFinally: onFinally
                                });
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 20000, // Tăng timeout lên 20 giây
                                maximumAge: 60000 // Cho phép dùng cache trong 1 phút
                            }
                        );
                    }
                    
                    // On first load: get location first, then init map based on that (no dummy)
                    requestUserLocation({ showPopup: false, notify: false });
                    
                    // Add click handler for location button
                    var btnLocation = document.getElementById('btn-current-location');
                    var btnSearchNearby = document.getElementById('btn-search-nearby');
                    if (btnLocation) {
                        btnLocation.addEventListener('click', function() {
                            btnLocation.style.opacity = '0.6';
                            btnLocation.disabled = true;

                            requestUserLocation({
                                showPopup: true,
                                notify: true,
                                onFinally: function() {
                                    btnLocation.style.opacity = '1';
                                    btnLocation.disabled = false;
                                }
                            });
                        });
                    }

                    function clearSerpMarkers() {
                        for (var i = 0; i < serpMarkers.length; i++) {
                            try { mapInstance.removeLayer(serpMarkers[i]); } catch (e) {}
                        }
                        serpMarkers = [];
                    }

                    // Hàm helper để cập nhật popup với trạng thái
                    async function updateMarkerPopupWithStatus(marker, title, address, rating, reviews) {
                        if (!marker || !marker.stationData) return;
                        
                        try {
                            var stationData = marker.stationData;
                            var enrichedStation = await enrichStationWithDbData(stationData);
                            var statusText = enrichedStation.statusText || 'Đang cập nhật';
                            var statusClass = enrichedStation.statusClass || 'status-available';
                            
                            // Tạo popup mới với trạng thái
                            var updatedPopup = '<b>' + escapeHtml(title || 'Địa điểm') + '</b>';
                            if (address) updatedPopup += '<br/>' + escapeHtml(address);
                            if (rating) updatedPopup += '<br/>Đánh giá: ' + escapeHtml(typeof rating === 'number' ? rating.toFixed(1) : rating) + (reviews ? ' (' + escapeHtml(reviews) + ')' : '');
                            
                            // Thêm trạng thái với màu sắc
                            var statusColor = '#10B981'; // Mặc định xanh lá (available)
                            if (statusText && statusText.toLowerCase().includes('cập nhật')) {
                                statusColor = '#9CA3AF'; // Xám cho trạng thái đang cập nhật
                            } else if (statusClass === 'status-full') {
                                statusColor = '#EF4444'; // Đỏ (full)
                            } else if (statusClass === 'status-busy') {
                                statusColor = '#FF9800'; // Cam (busy)
                            } else if (statusClass === 'status-updating') {
                                statusColor = '#9CA3AF';
                            }
                            
                            updatedPopup += '<br/>Trạng thái: <span style="color:' + statusColor + ';font-weight:bold;">' + escapeHtml(statusText) + '</span>';
                            
                            // Cập nhật popup
                            marker.setPopupContent(updatedPopup);
                            marker.openPopup();
                            
                            // Cập nhật stationData đã enrich (merge với dữ liệu cũ, set trực tiếp vào reference để tránh trigger setter)
                            if (marker._originalStationDataRef && marker._originalStationDataRef.data) {
                                Object.assign(marker._originalStationDataRef.data, enrichedStation);
                            }
                        } catch (err) {
                            console.error('Error updating marker popup with status:', err);
                        }
                    }

                    function addSerpMarker(lat, lng, title, address, rating, reviews) {
                        if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) {
                            return null;
                        }
                        var color = '#030213';
                        var icon = L.divIcon({
                            className: 'custom-marker',
                            html: '<div style="background:' + color + ';width:14px;height:14px;border-radius:50%;border:2px solid white;"></div>',
                            iconSize: [14, 14],
                            iconAnchor: [7, 7]
                        });
                        var m = L.marker([lat, lng], { icon: icon }).addTo(mapInstance);
                        var popup = '<b>' + escapeHtml(title || 'Địa điểm') + '</b>';
                        if (address) popup += '<br/>' + escapeHtml(address);
                        if (rating) popup += '<br/>Đánh giá: ' + escapeHtml(typeof rating === 'number' ? rating.toFixed(1) : rating) + (reviews ? ' (' + escapeHtml(reviews) + ')' : '');
                        popup += '<br/>Trạng thái: <span style="color:#666;">Đang tải...</span>';
                        // Cho phép mở nhiều popup đồng thời và mở ngay sau khi thêm marker
                        m.bindPopup(popup, { autoClose: false, closeOnClick: false, autoPan: false });
                        m.openPopup();
                        
                        // Sau khi stationData được set, cập nhật popup với trạng thái
                        // Sử dụng Object.defineProperty để intercept việc set stationData
                        var originalStationData = null;
                        var isUpdating = false;
                        m._originalStationDataRef = { data: null }; // Lưu reference để có thể update từ bên ngoài
                        Object.defineProperty(m, 'stationData', {
                            get: function() {
                                return originalStationData;
                            },
                            set: function(value) {
                                originalStationData = value;
                                m._originalStationDataRef.data = value;
                                if (value && !isUpdating) {
                                    isUpdating = true;
                                    // Cập nhật popup với trạng thái sau khi stationData được set
                                    updateMarkerPopupWithStatus(m, title, address, rating, reviews).finally(function() {
                                        isUpdating = false;
                                    });
                                }
                            },
                            configurable: true
                        });
                        
                        m.on('click', function() {
                            var data = m.stationData || {
                                title: title,
                                address: address,
                                rating: rating,
                                ratingText: rating ? (typeof rating === 'number' ? rating.toFixed(1) : rating) + (reviews ? ' (' + reviews + ')' : '') : 'Chưa có đánh giá',
                                reviews: reviews,
                                priceText: '--',
                                connectorsText: '--',
                                distanceText: '--'
                            };
                            console.log('Marker clicked, showing station details:', data);
                            showStationDetails(data);
                        });
                        serpMarkers.push(m);
                        return m;
                    }

                    function searchNearbyStations(previousState) {
                        if (!mapInstance) return Promise.resolve([]);
                        var center = mapInstance.getCenter();
                        var url = '/api/maps/search?query=' + encodeURIComponent('EV charging station') + '&lat=' + encodeURIComponent(center.lat) + '&lng=' + encodeURIComponent(center.lng) + '&zoom=' + encodeURIComponent(mapInstance.getZoom() || 14);
                        return fetch(url).then(function(r){ 
                            if (!r.ok) throw new Error('Request failed'); 
                            return r.json(); 
                        }).then(function(list){
                            var normalized = [];
                            if (Array.isArray(list)) {
                                clearSerpMarkers();
                                for (var i = 0; i < list.length; i++) {
                                    var raw = list[i] || {};
                                    var lat = raw.latitude != null ? raw.latitude : raw.Latitude;
                                    var lng = raw.longitude != null ? raw.longitude : raw.Longitude;
                                    if (typeof lat === 'string') lat = parseFloat(lat);
                                    if (typeof lng === 'string') lng = parseFloat(lng);
                                    if (typeof lat !== 'number' || isNaN(lat) || typeof lng !== 'number' || isNaN(lng)) {
                                        continue;
                                    }
                                    var rating = raw.rating != null ? raw.rating : raw.Rating;
                                    if (typeof rating === 'string') rating = parseFloat(rating);
                                    if (typeof rating !== 'number' || isNaN(rating)) rating = null;
                                    var reviews = raw.reviews != null ? raw.reviews : raw.Reviews;
                                    if (typeof reviews === 'string') reviews = parseInt(reviews, 10);
                                    if (typeof reviews !== 'number' || isNaN(reviews)) reviews = null;
                                    var item = {
                                        title: raw.title || raw.Title || 'Trạm sạc',
                                        address: raw.address || raw.Address || '',
                                        rating: rating,
                                        reviews: reviews,
                                        latitude: lat,
                                        longitude: lng
                                    };
                                    normalized.push(item);
                                    var marker = addSerpMarker(item.latitude, item.longitude, item.title, item.address, item.rating, item.reviews);
                                    if (marker) {
                                        marker.stationData = item;
                                    }
                                }
                            } else {
                                normalized = [];
                                clearSerpMarkers();
                            }
                            updateSidebarWithSerpResults(normalized, center);
                            return normalized;
                        }).catch(function(err){
                            if (previousState) {
                                applySidebarState(previousState);
                                lastSidebarState = previousState;
                            }
                            throw err;
                        });
                    }

                    // Thêm chức năng tìm kiếm từ input
                    var searchInput = document.querySelector('.search-input');
                    var searchDebounceTimer = null;
                    // Initialize isSearching in global scope if not already defined
                    if (typeof window.isSearching === 'undefined') {
                        window.isSearching = false;
                    }
                    
                    function performSearch(searchQuery) {
                        if (!mapInstance || !searchQuery.trim()) return;
                        
                        window.isSearching = true; // Đánh dấu đang tìm kiếm
                        var center = mapInstance.getCenter();
                        var previousState = captureSidebarState();
                        setSidebarLoading('Đang tìm kiếm "' + searchQuery + '"...');
                        
                        // Gọi API tìm kiếm với query từ input
                        var url = '/api/maps/search?query=' + encodeURIComponent(searchQuery) + '&lat=' + encodeURIComponent(center.lat) + '&lng=' + encodeURIComponent(center.lng) + '&zoom=' + encodeURIComponent(mapInstance.getZoom() || 14);
                        
                        fetch(url).then(function(r){ 
                            if (!r.ok) throw new Error('Request failed'); 
                            return r.json(); 
                        }).then(function(list){
                            var normalized = [];
                            if (Array.isArray(list)) {
                                clearSerpMarkers();
                                for (var i = 0; i < list.length; i++) {
                                    var place = list[i];
                                    if (!place || typeof place !== 'object') continue;
                                    
                                    var item = {
                                        id: 'serp_' + i,
                                        title: place.title || '',
                                        address: place.address || '',
                                        latitude: place.latitude || 0,
                                        longitude: place.longitude || 0,
                                        rating: place.rating || 0,
                                        reviews: place.reviews || 0,
                                        isFromApi: true
                                    };
                                    normalized.push(item);
                                    var marker = addSerpMarker(item.latitude, item.longitude, item.title, item.address, item.rating, item.reviews);
                                    if (marker) {
                                        marker.stationData = item;
                                    }
                                }
                            } else {
                                normalized = [];
                                clearSerpMarkers();
                            }
                            updateSidebarWithSerpResults(normalized, center);
                            window.isSearching = false; // Reset flag sau khi hoàn thành
                        }).catch(function(err){
                            console.error('Search error:', err);
                            window.isSearching = false; // Reset flag khi lỗi
                            if (previousState) {
                                applySidebarState(previousState);
                                lastSidebarState = previousState;
                            }
                            alert('Không thể thực hiện tìm kiếm. Vui lòng thử lại sau.');
                        });
                    }
                    
                    // Event listener cho input tìm kiếm với debounce
                    if (searchInput) {
                        searchInput.addEventListener('input', function(e) {
                            var query = e.target.value.trim();
                            
                            // Clear timeout cũ nếu có
                            if (searchDebounceTimer) {
                                clearTimeout(searchDebounceTimer);
                            }
                            
                            // Nếu query rỗng, hiển thị lại danh sách mặc định
                            if (!query) {
                                // Khôi phục trạng thái mặc định của sidebar
                                applySidebarState(defaultSidebarState);
                                lastSidebarState = defaultSidebarState;
                                // Xóa các marker từ SerpApi trên bản đồ
                                clearSerpMarkers();
                                resetStationDetails();
                                return;
                            }
                            
                            // Debounce 500ms để tránh gọi API liên tục khi người dùng đang gõ
                            searchDebounceTimer = setTimeout(function() {
                                performSearch(query);
                            }, 500);
                        });
                        
                        // Xử lý khi nhấn Enter
                        searchInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                var query = e.target.value.trim();
                                if (query) {
                                    // Clear debounce timer và thực hiện tìm kiếm ngay
                                    if (searchDebounceTimer) {
                                        clearTimeout(searchDebounceTimer);
                                    }
                                    performSearch(query);
                                }
                            }
                        });
                    }
                    
                    if (btnSearchNearby) {
                        btnSearchNearby.addEventListener('click', function() {
                            if (!mapInstance) return;
                            
                            // Kiểm tra xem có filter nào được chọn không
                            var connectorTypeEl = document.getElementById('filter-connector-type');
                            var statusFilterEl = document.getElementById('filter-status');
                            var sortByEl = document.getElementById('filter-sort');
                            var radiusEl = document.getElementById('filter-radius');
                            
                            var hasFilter = (connectorTypeEl && connectorTypeEl.value) || 
                                          (statusFilterEl && statusFilterEl.value) || 
                                          (sortByEl && sortByEl.value !== 'distance') ||
                                          (radiusEl && parseFloat(radiusEl.value) !== 10);
                            
                            // Nếu có filter, dùng applyFilters, nếu không thì dùng searchNearbyStations
                            if (hasFilter && typeof window.applyFilters === 'function') {
                                btnSearchNearby.style.opacity = '0.6';
                                btnSearchNearby.disabled = true;
                                
                                // Lưu trạng thái ban đầu của isSearching
                                var wasSearching = window.isSearching || false;
                                window.applyFilters();
                                
                                // Đợi cho applyFilters hoàn thành bằng cách kiểm tra isSearching flag
                                var checkInterval = setInterval(function() {
                                    if (!window.isSearching) {
                                        clearInterval(checkInterval);
                                        btnSearchNearby.style.opacity = '1';
                                        btnSearchNearby.disabled = false;
                                    }
                                }, 100);
                                
                                // Timeout để đảm bảo button được reset sau tối đa 10 giây
                                setTimeout(function() {
                                    clearInterval(checkInterval);
                                    btnSearchNearby.style.opacity = '1';
                                    btnSearchNearby.disabled = false;
                                }, 10000);
                            } else {
                                var previousState = captureSidebarState();
                                setSidebarLoading('Đang tìm trạm sạc gần bạn...');
                                btnSearchNearby.style.opacity = '0.6';
                                btnSearchNearby.disabled = true;
                                searchNearbyStations(previousState).catch(function(){
                                    alert('Không thể tải dữ liệu trạm sạc. Vui lòng thử lại sau.');
                                }).finally(function(){
                                    btnSearchNearby.style.opacity = '1';
                                    btnSearchNearby.disabled = false;
                                });
                            }
                        });
                    }

                    // Kiểm tra authentication khi page load
                    checkAuthentication();

                    // Initialize SignalR
                    initSignalR();

                    // Xử lý nút "Đặt trước"
                    var btnReserve = document.getElementById('btn-reserve');
                    if (btnReserve) {
                        btnReserve.addEventListener('click', function() {
                            if (!selectedStation || !selectedStation.stationId) {
                                alert('Vui lòng chọn một trạm sạc từ hệ thống để đặt trước.');
                                return;
                            }
                            if (!isUserAuthenticated) {
                                alert('Vui lòng đăng nhập để đặt trước trạm sạc.');
                                window.location.href = '/Auth/Login';
                                return;
                            }
                            openReservationModal();
                        });
                    }

                    // Xử lý nút "Bắt đầu sạc"
                    var btnStartCharging = document.getElementById('btn-start-charging');
                    if (btnStartCharging) {
                        btnStartCharging.addEventListener('click', function() {
                            if (!selectedStation || !selectedStation.stationId) {
                                alert('Vui lòng chọn một trạm sạc từ hệ thống.');
                                return;
                            }
                            if (!isUserAuthenticated) {
                                alert('Vui lòng đăng nhập để bắt đầu sạc.');
                                window.location.href = '/Auth/Login';
                                return;
                            }
                            // Chuyển đến trang bắt đầu sạc với stationId
                            window.location.href = `/Driver/StartCharging?stationId=${selectedStation.stationId}`;
                        });
                    }

                    // Xử lý nút "Chỉ đường"
                    var btnDirection = document.getElementById('btn-direction');
                    if (btnDirection) {
                        btnDirection.addEventListener('click', function() {
                            if (!selectedStation) return;
                            var lat = selectedStation.latitude || selectedStation.lat;
                            var lng = selectedStation.longitude || selectedStation.lng;
                            if (lat && lng) {
                                var url = 'https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lng;
                                window.open(url, '_blank');
                            }
                        });
                    }


                    // Define applyFilters function in global scope
                    window.applyFilters = function() {
                        if (!mapInstance) {
                            alert('Bản đồ chưa sẵn sàng. Vui lòng đợi một chút.');
                            return;
                        }
                        
                        var center = mapInstance.getCenter();
                        if (!center) {
                            alert('Không thể lấy vị trí trung tâm bản đồ.');
                            return;
                        }
                        
                        var connectorTypeEl = document.getElementById('filter-connector-type');
                        var statusFilterEl = document.getElementById('filter-status');
                        var sortByEl = document.getElementById('filter-sort');
                        var radiusEl = document.getElementById('filter-radius');
                        
                        if (!connectorTypeEl || !statusFilterEl || !sortByEl || !radiusEl) {
                            console.error('Filter elements not found');
                            return;
                        }
                        
                        var connectorType = connectorTypeEl.value;
                        var statusFilter = statusFilterEl.value;
                        var sortBy = sortByEl.value;
                        var radius = parseFloat(radiusEl.value) || 10;

                        var url = '/api/ChargingStation/nearest?lat=' + center.lat + '&lng=' + center.lng + '&radiusKm=' + radius;
                        if (connectorType) {
                            url += '&connectorType=' + encodeURIComponent(connectorType);
                        }

                        // Check if already searching to avoid conflicts
                        if (typeof window.isSearching !== 'undefined' && window.isSearching) {
                            console.log('Search already in progress, skipping...');
                            return;
                        }
                        
                        // Set searching flag
                        window.isSearching = true;
                        
                        if (typeof setSidebarLoading === 'function') {
                            setSidebarLoading('Đang tìm kiếm...');
                        }
                        
                        fetch(url, {
                            credentials: 'include'
                        }).then(function(r) {
                            if (!r.ok) {
                                throw new Error('Request failed with status: ' + r.status);
                            }
                            return r.json();
                        }).then(function(stations) {
                            if (!Array.isArray(stations)) {
                                console.error('Invalid response:', stations);
                                alert('Dữ liệu trả về không hợp lệ.');
                                return;
                            }
                            
                            // Filter by status (available spots)
                            if (statusFilter === 'Available') {
                                stations = stations.filter(function(s) { return s.availableSpots > 0; });
                            } else if (statusFilter === 'Occupied') {
                                stations = stations.filter(function(s) { return s.availableSpots > 0 && s.availableSpots < s.totalSpots; });
                            } else if (statusFilter === 'Full') {
                                stations = stations.filter(function(s) { return s.availableSpots === 0; });
                            }

                            // Sort
                            if (sortBy === 'distance') {
                                stations.sort(function(a, b) { return (a.distanceKm || 0) - (b.distanceKm || 0); });
                            } else if (sortBy === 'rating') {
                                stations.sort(function(a, b) { return (b.externalRating || 0) - (a.externalRating || 0); });
                            } else if (sortBy === 'name') {
                                stations.sort(function(a, b) { return a.name.localeCompare(b.name); });
                            }

                            // Update map and sidebar
                            if (typeof clearSerpMarkers === 'function') {
                                clearSerpMarkers();
                            }
                            
                            var normalized = stations.map(function(s) {
                                var marker = null;
                                if (typeof addSerpMarker === 'function') {
                                    marker = addSerpMarker(
                                        parseFloat(s.latitude),
                                        parseFloat(s.longitude),
                                        s.name,
                                        s.address,
                                        s.externalRating,
                                        s.externalReviewCount
                                    );
                                }
                                
                                if (marker) {
                                    marker.stationData = {
                                        title: s.name,
                                        address: s.address,
                                        latitude: parseFloat(s.latitude),
                                        longitude: parseFloat(s.longitude),
                                        stationId: s.id,
                                        availableSpots: s.availableSpots,
                                        totalSpots: s.totalSpots,
                                        distanceKm: s.distanceKm,
                                        distanceText: s.distanceKm ? s.distanceKm.toFixed(1) + ' km' : '--'
                                    };
                                }
                                
                                return {
                                    title: s.name,
                                    address: s.address,
                                    latitude: parseFloat(s.latitude),
                                    longitude: parseFloat(s.longitude),
                                    rating: s.externalRating,
                                    reviews: s.externalReviewCount,
                                    stationId: s.id,
                                    availableSpots: s.availableSpots,
                                    totalSpots: s.totalSpots,
                                    distanceKm: s.distanceKm,
                                    distanceText: s.distanceKm ? s.distanceKm.toFixed(1) + ' km' : '--'
                                };
                            });
                            
                            if (typeof updateSidebarWithSerpResults === 'function') {
                                updateSidebarWithSerpResults(normalized, center);
                            } else {
                                console.error('updateSidebarWithSerpResults function not found');
                            }
                            
                            // Reset searching flag
                            window.isSearching = false;
                        }).catch(function(err) {
                            console.error('Error applying filters:', err);
                            alert('Không thể áp dụng bộ lọc: ' + (err.message || 'Vui lòng thử lại.'));
                            // Reset searching flag on error
                            window.isSearching = false;
                        });
                    };
                }
            }
        }, 1000);

        // Mở modal đặt trước
        async function openReservationModal() {
            if (!selectedStation || !selectedStation.stationId) return;

            var modal = new bootstrap.Modal(document.getElementById('reservationModal'));
            var stationId = selectedStation.stationId;
            document.getElementById('reservation-station-id').value = stationId;
            document.getElementById('reservation-station-name').value = selectedStation.title || selectedStation.name || '';

            // Subscribe to station for real-time updates
            if (signalRConnection) {
                await subscribeStationSignalR(stationId);
            }

            // Load danh sách spots (với status hiện tại của trạm)
            await loadSpotsForReservation(stationId, selectedStation?.status);

            // Load danh sách vehicles
            await loadVehiclesForReservation();

            // Set thời gian mặc định (1 giờ sau, kết thúc sau 2 giờ)
            var now = new Date();
            var startTime = new Date(now);
            startTime.setHours(startTime.getHours() + 1);
            var endTime = new Date(startTime);
            endTime.setHours(endTime.getHours() + 2);

            document.getElementById('reservation-start-time').value = formatDateTimeLocal(startTime);
            document.getElementById('reservation-end-time').value = formatDateTimeLocal(endTime);
            
            // Reset payment method to cash
            document.getElementById('paymentCash').checked = true;
            document.getElementById('reservation-estimated-cost').value = '0';

            // Add event listeners for cost calculation
            var spotSelect = document.getElementById('reservation-spot-select');
            var startTimeInput = document.getElementById('reservation-start-time');
            var endTimeInput = document.getElementById('reservation-end-time');
            var energyInput = document.getElementById('reservation-energy');
            
            function calculateEstimatedCost() {
                var spotId = spotSelect.value;
                var startTime = startTimeInput.value;
                var endTime = endTimeInput.value;
                var energy = parseFloat(energyInput.value) || 0;
                
                // Base fee giống như khi sạc thực tế (thống nhất logic)
                const BASE_FEE = 10000; // Phí cơ bản 10k VND
                
                if (!spotId || !startTime || !endTime) {
                    document.getElementById('reservation-estimated-cost').value = '0';
                    return;
                }
                
                // Get selected spot price
                var selectedOption = spotSelect.options[spotSelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.price) {
                    var pricePerKwh = parseFloat(selectedOption.dataset.price);
                    if (!isNaN(pricePerKwh) && energy > 0) {
                        // Tính cost = (energy * price) + base fee (giống logic session thực tế)
                        var estimatedCost = (pricePerKwh * energy) + BASE_FEE;
                        document.getElementById('reservation-estimated-cost').value = Math.round(estimatedCost).toLocaleString('vi-VN');
                    } else {
                        // Nếu không có energy, vẫn hiển thị base fee tối thiểu
                        document.getElementById('reservation-estimated-cost').value = BASE_FEE.toLocaleString('vi-VN');
                    }
                } else {
                    // Nếu không có price, vẫn hiển thị base fee tối thiểu
                    document.getElementById('reservation-estimated-cost').value = BASE_FEE.toLocaleString('vi-VN');
                }
            }
            
            spotSelect.addEventListener('change', function() {
                calculateEstimatedCost();
                validateReservationVehicleSpotCompatibility();
            });
            startTimeInput.addEventListener('change', calculateEstimatedCost);
            endTimeInput.addEventListener('change', calculateEstimatedCost);
            energyInput.addEventListener('input', calculateEstimatedCost);
            
            // Add validation listener cho vehicle select
            var vehicleSelect = document.getElementById('reservation-vehicle-select');
            if (vehicleSelect) {
                vehicleSelect.addEventListener('change', validateReservationVehicleSpotCompatibility);
            }

            modal.show();
        }

        function formatDateTimeLocal(date) {
            var d = new Date(date);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().slice(0, 16);
        }

        async function loadSpotsForReservation(stationId, stationStatus) {
            var select = document.getElementById('reservation-spot-select');
            if (!select) return;

            select.innerHTML = '<option value="">-- Đang tải --</option>';

            try {
                // Kiểm tra status của trạm trước
                var stationResponse = await fetch('/api/ChargingStation/' + stationId, {
                    credentials: 'include'
                });
                
                var isStationInactive = false;
                if (stationResponse.ok) {
                    var stationData = await stationResponse.json();
                    var status = stationStatus || stationData.status;
                    isStationInactive = status === 'Inactive' || status === 'Maintenance' || status === 'Closed' || status === 1 || status === 2 || status === 3;
                }

                // Load all spots with reservation info (not just available)
                var response = await fetch('/api/ChargingSpot/station/' + stationId + '/all', {
                    credentials: 'include'
                });
                if (response.ok) {
                    var spots = await response.json();
                    
                    if (isStationInactive) {
                        // Trạm bị tắt - hiển thị thông báo và disable tất cả spots
                        select.innerHTML = '<option value="">-- Trạm đã bị tắt, không thể đặt lịch --</option>';
                        select.disabled = true;
                        
                        // Disable nút submit form
                        var btnSubmitReservation = document.getElementById('btn-submit-reservation');
                        if (btnSubmitReservation) {
                            btnSubmitReservation.disabled = true;
                            btnSubmitReservation.classList.add('disabled');
                        }
                        
                        // Hiển thị cảnh báo trong modal
                        var modalBody = document.querySelector('#reservationModal .modal-body');
                        if (modalBody) {
                            var existingAlert = modalBody.querySelector('.station-inactive-alert');
                            if (!existingAlert) {
                                var alertDiv = document.createElement('div');
                                alertDiv.className = 'alert alert-warning station-inactive-alert';
                                alertDiv.innerHTML = '<strong>Cảnh báo:</strong> Trạm này đã bị tắt. Bạn không thể đặt lịch tại trạm này.';
                                modalBody.insertBefore(alertDiv, modalBody.firstChild);
                            }
                        }
                    } else {
                        // Trạm đang hoạt động - load spots bình thường
                        select.disabled = false;
                        
                        // Enable nút submit form
                        var btnSubmitReservation = document.getElementById('btn-submit-reservation');
                        if (btnSubmitReservation) {
                            btnSubmitReservation.disabled = false;
                            btnSubmitReservation.classList.remove('disabled');
                        }
                        
                        // Xóa cảnh báo nếu có
                        var modalBody = document.querySelector('#reservationModal .modal-body');
                        if (modalBody) {
                            var existingAlert = modalBody.querySelector('.station-inactive-alert');
                            if (existingAlert) {
                                existingAlert.remove();
                            }
                        }
                        
                        select.innerHTML = '<option value="">-- Chọn cổng sạc --</option>';
                        spots.forEach(function(spot) {
                            var option = document.createElement('option');
                            option.value = spot.id;
                            var spotText = 'Cổng ' + spot.spotNumber + ' - ' + (spot.connectorType || 'N/A') + ' (' + (spot.powerOutputKw || spot.powerOutput || 'N/A') + 'kW)';
                            
                            // If spot is reserved or not available, mark it
                            if (spot.isReserved || !spot.isAvailable) {
                                spotText += ' (Đã được đặt)';
                                option.disabled = true;
                                option.classList.add('text-muted');
                                option.style.color = '#9ca3af'; // Gray color
                                option.style.backgroundColor = '#f3f4f6';
                            }
                            
                            option.textContent = spotText;
                            if (spot.pricePerKwh) {
                                option.dataset.price = spot.pricePerKwh;
                            }
                            option.dataset.isReserved = spot.isReserved || false;
                            option.dataset.isAvailable = spot.isAvailable || false;
                            select.appendChild(option);
                        });
                    }
                } else {
                    select.innerHTML = '<option value="">-- Không có cổng sạc --</option>';
                }
            } catch (err) {
                console.error('Error loading spots:', err);
                select.innerHTML = '<option value="">-- Lỗi tải dữ liệu --</option>';
            }
        }

        async function loadVehiclesForReservation() {
            var select = document.getElementById('reservation-vehicle-select');
            if (!select) return;

            select.innerHTML = '<option value="">-- Đang tải --</option>';

            try {
                var response = await fetch('/api/Vehicle', {
                    credentials: 'include'
                });
                if (response.ok) {
                    var vehicles = await response.json();
                    select.innerHTML = '<option value="">-- Chọn xe --</option>';
                    if (vehicles && vehicles.length > 0) {
                        vehicles.forEach(function(vehicle) {
                            var option = document.createElement('option');
                            option.value = vehicle.id;
                            option.textContent = vehicle.make + ' ' + vehicle.model + ' (' + vehicle.licensePlate + ')';
                            // Lưu preferred spot ID vào data attribute để validate sau
                            var preferredSpotId = getPreferredSpotIdReservation(vehicle);
                            if (preferredSpotId) {
                                option.dataset.preferredSpotId = preferredSpotId;
                            }
                            // Lưu toàn bộ vehicle object vào dataset để dễ truy cập
                            option.dataset.vehicleData = JSON.stringify(vehicle);
                            select.appendChild(option);
                        });
                    } else {
                        select.innerHTML = '<option value="">-- Bạn chưa có xe. Vui lòng thêm xe trước.</option>';
                    }
                } else if (response.status === 401) {
                    select.innerHTML = '<option value="">-- Vui lòng đăng nhập --</option>';
                } else {
                    select.innerHTML = '<option value="">-- Không có xe --</option>';
                }
            } catch (err) {
                console.error('Error loading vehicles:', err);
                select.innerHTML = '<option value="">-- Lỗi tải dữ liệu --</option>';
            }
        }

        // Submit form đặt trước
        // Initialize filter button handler on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            // Setup filter button click handler
            var btnApplyFilters = document.getElementById('btn-apply-filters');
            if (btnApplyFilters) {
                btnApplyFilters.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (typeof window.applyFilters === 'function') {
                        window.applyFilters();
                    } else {
                        // Wait a bit for the function to be defined
                        setTimeout(function() {
                            if (typeof window.applyFilters === 'function') {
                                window.applyFilters();
                            } else {
                                alert('Bộ lọc đang được khởi tạo, vui lòng đợi vài giây rồi thử lại.');
                            }
                        }, 1500);
                    }
                });
            }
            
            // Setup radius slider
            var filterRadius = document.getElementById('filter-radius');
            var radiusValue = document.getElementById('radius-value');
            if (filterRadius && radiusValue) {
                filterRadius.addEventListener('input', function() {
                    radiusValue.textContent = this.value;
                });
            }
        });
        
        // Add Vehicle Modal Functions for Reservation
        document.addEventListener('DOMContentLoaded', function() {
            var btnAddVehicleReservation = document.getElementById('btn-add-vehicle-reservation');
            if (btnAddVehicleReservation) {
                btnAddVehicleReservation.addEventListener('click', function() {
                    var modal = new bootstrap.Modal(document.getElementById('addVehicleModalReservation'));
                    modal.show();
                });
            }
            
            var btnSaveVehicleReservation = document.getElementById('btn-save-vehicle-reservation');
            if (btnSaveVehicleReservation) {
                btnSaveVehicleReservation.addEventListener('click', handleSaveVehicleReservation);
            }
            
            // Load spots when modal opens
            var addVehicleModalReservation = document.getElementById('addVehicleModalReservation');
            if (addVehicleModalReservation) {
                addVehicleModalReservation.addEventListener('show.bs.modal', function() {
                    loadSpotsForAddVehicleModalReservation();
                });
            }
        });
        
        async function loadSpotsForAddVehicleModalReservation() {
            var select = document.getElementById('add-vehicle-spot-select-reservation');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Đang tải --</option>';
            
            try {
                // Load tất cả stations và spots
                var stationsResponse = await fetch('/api/ChargingStation', {
                    credentials: 'include'
                });
                
                if (stationsResponse.ok) {
                    var stations = await stationsResponse.json();
                    select.innerHTML = '<option value="">-- Chọn cổng sạc (tùy chọn) --</option>';
                    
                    // Load spots từ tất cả stations
                    for (var i = 0; i < stations.length; i++) {
                        var station = stations[i];
                        try {
                            var spotsResponse = await fetch('/api/ChargingSpot/station/' + station.id, {
                                credentials: 'include'
                            });
                            if (spotsResponse.ok) {
                                var spots = await spotsResponse.json();
                                spots.forEach(function(spot) {
                                    var option = document.createElement('option');
                                    option.value = spot.id;
                                    option.textContent = station.name + ' - Cổng ' + spot.spotNumber + ' (' + (spot.connectorType || 'N/A') + ')';
                                    select.appendChild(option);
                                });
                            }
                        } catch (err) {
                            console.error('Error loading spots for station ' + station.id + ':', err);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading spots:', error);
                select.innerHTML = '<option value="">-- Lỗi tải dữ liệu --</option>';
            }
        }
        
        async function handleSaveVehicleReservation() {
            var form = document.getElementById('add-vehicle-form-reservation');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            var make = document.getElementById('vehicle-make-reservation').value.trim();
            var licensePlate = document.getElementById('vehicle-license-plate-reservation').value.trim();
            var model = document.getElementById('vehicle-model-reservation').value.trim() || make;
            var spotId = document.getElementById('add-vehicle-spot-select-reservation').value;
            
            if (!make || !licensePlate) {
                alert('Vui lòng nhập đầy đủ hãng xe và biển số.');
                return;
            }
            
            var btnSave = document.getElementById('btn-save-vehicle-reservation');
            btnSave.disabled = true;
            btnSave.textContent = 'Đang lưu...';
            
            try {
                // Lưu preferred spot ID vào Notes nếu có chọn
                var notes = '';
                if (spotId) {
                    notes = 'PREFERRED_SPOT_ID:' + spotId;
                }
                
                var vehicleData = {
                    make: make,
                    model: model,
                    licensePlate: licensePlate,
                    vehicleType: 'Car',
                    isPrimary: false,
                    notes: notes || null
                };
                
                var response = await fetch('/api/Vehicle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(vehicleData)
                });
                
                if (response.ok) {
                    var newVehicle = await response.json();
                    
                    // Đóng modal
                    var modal = bootstrap.Modal.getInstance(document.getElementById('addVehicleModalReservation'));
                    modal.hide();
                    
                    // Reset form
                    form.reset();
                    
                    // Reload danh sách xe và chọn xe vừa thêm
                    await loadVehiclesForReservation();
                    document.getElementById('reservation-vehicle-select').value = newVehicle.id;
                    
                    // Validate compatibility sau khi thêm xe
                    validateReservationVehicleSpotCompatibility();
                    
                    alert('Thêm xe thành công!');
                } else {
                    var error = await response.json();
                    alert('Lỗi: ' + (error.message || 'Không thể thêm xe'));
                }
            } catch (error) {
                console.error('Error saving vehicle:', error);
                alert('Có lỗi xảy ra. Vui lòng thử lại.');
            } finally {
                btnSave.disabled = false;
                btnSave.textContent = 'Lưu';
            }
        }
        
        // Helper function để lấy preferred spot ID từ vehicle notes
        function getPreferredSpotIdReservation(vehicle) {
            if (!vehicle || !vehicle.notes) return null;
            var match = vehicle.notes.match(/PREFERRED_SPOT_ID:([a-f0-9-]+)/i);
            return match ? match[1] : null;
        }
        
        // Validate xem xe đã chọn có compatible với cổng sạc đã chọn không (cho reservation)
        function validateReservationVehicleSpotCompatibility() {
            var vehicleSelect = document.getElementById('reservation-vehicle-select');
            var spotSelect = document.getElementById('reservation-spot-select');
            var btnSubmit = document.getElementById('btn-submit-reservation');
            
            if (!vehicleSelect || !spotSelect) return;
            
            var selectedVehicleOption = vehicleSelect.options[vehicleSelect.selectedIndex];
            var selectedSpotId = spotSelect.value;
            
            if (!selectedVehicleOption || !selectedVehicleOption.value || !selectedSpotId) {
                return; // Chưa chọn đủ, không validate
            }
            
            var preferredSpotId = selectedVehicleOption.dataset.preferredSpotId;
            
            if (preferredSpotId && preferredSpotId !== selectedSpotId) {
                // Xe có cổng sạc ưa thích nhưng không khớp với cổng đã chọn
                var vehicleData = JSON.parse(selectedVehicleOption.dataset.vehicleData || '{}');
                var vehicleName = vehicleData.licensePlate 
                    ? vehicleData.make + ' ' + vehicleData.model + ' (' + vehicleData.licensePlate + ')'
                    : vehicleData.make + ' ' + vehicleData.model;
                
                alert('Cảnh báo: Xe "' + vehicleName + '" chỉ tương thích với cổng sạc đã đăng ký. Vui lòng chọn cổng sạc phù hợp hoặc chọn xe khác.');
                
                // Disable nút submit
                if (btnSubmit) {
                    btnSubmit.disabled = true;
                    btnSubmit.style.opacity = '0.5';
                }
            } else {
                // Khớp hoặc không có preferred spot, enable nút
                if (btnSubmit) {
                    btnSubmit.disabled = false;
                    btnSubmit.style.opacity = '1';
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            var btnSubmitReservation = document.getElementById('btn-submit-reservation');
            if (btnSubmitReservation) {
                btnSubmitReservation.addEventListener('click', async function() {
                    var form = document.getElementById('reservationForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    // Kiểm tra trạm có bị tắt không
                    var stationId = document.getElementById('reservation-station-id').value;
                    if (stationId) {
                        try {
                            var stationResponse = await fetch('/api/ChargingStation/' + stationId, {
                                credentials: 'include'
                            });
                            if (stationResponse.ok) {
                                var stationData = await stationResponse.json();
                                var status = stationData.status;
                                var isStationInactive = status === 'Inactive' || status === 'Maintenance' || status === 'Closed' || status === 1 || status === 2 || status === 3;
                                if (isStationInactive) {
                                    alert('Trạm này đã bị tắt. Bạn không thể đặt lịch tại trạm này.');
                                    return;
                                }
                            }
                        } catch (err) {
                            console.error('Error checking station status:', err);
                        }
                    }

                    var spotId = document.getElementById('reservation-spot-select').value;
                    var vehicleId = document.getElementById('reservation-vehicle-select').value;
                    var startTime = document.getElementById('reservation-start-time').value;
                    var endTime = document.getElementById('reservation-end-time').value;
                    var energy = document.getElementById('reservation-energy').value;
                    var estimatedCostStr = document.getElementById('reservation-estimated-cost').value.replace(/,/g, '').trim();
                    var paymentMethodRadio = document.querySelector('input[name="paymentMethod"]:checked');
                    var notes = document.getElementById('reservation-notes').value;

                    if (!spotId || !vehicleId || !startTime || !endTime) {
                        alert('Vui lòng điền đầy đủ thông tin bắt buộc.');
                        return;
                    }
                    
                    // Validate vehicle-spot compatibility trước khi submit
                    var vehicleSelect = document.getElementById('reservation-vehicle-select');
                    var spotSelect = document.getElementById('reservation-spot-select');
                    if (vehicleSelect && spotSelect) {
                        var selectedVehicleOption = vehicleSelect.options[vehicleSelect.selectedIndex];
                        var selectedSpotId = spotSelect.value;
                        if (selectedVehicleOption && selectedVehicleOption.value && selectedSpotId) {
                            var preferredSpotId = selectedVehicleOption.dataset.preferredSpotId;
                            if (preferredSpotId && preferredSpotId !== selectedSpotId) {
                                var vehicleData = JSON.parse(selectedVehicleOption.dataset.vehicleData || '{}');
                                var vehicleName = vehicleData.licensePlate 
                                    ? vehicleData.make + ' ' + vehicleData.model + ' (' + vehicleData.licensePlate + ')'
                                    : vehicleData.make + ' ' + vehicleData.model;
                                alert('Không thể đặt lịch: Xe "' + vehicleName + '" chỉ tương thích với cổng sạc đã đăng ký. Vui lòng chọn cổng sạc phù hợp hoặc chọn xe khác.');
                                return;
                            }
                        }
                    }
                    
                    if (!paymentMethodRadio) {
                        alert('Vui lòng chọn phương thức thanh toán.');
                        return;
                    }
                    
                    var paymentMethod = paymentMethodRadio.value;
                    
                    var startDate = new Date(startTime);
                    var endDate = new Date(endTime);
                    if (endDate <= startDate) {
                        alert('Thời gian kết thúc phải sau thời gian bắt đầu.');
                        return;
                    }
                    
                    // Validate estimated cost if VNPay is selected
                    var estimatedCost = null;
                    if (estimatedCostStr && estimatedCostStr !== '0' && estimatedCostStr !== '') {
                        estimatedCost = parseFloat(estimatedCostStr);
                        if (isNaN(estimatedCost) || estimatedCost <= 0) {
                            estimatedCost = null;
                        }
                    }
                    
                    if (paymentMethod === 'vnpay' && (!estimatedCost || estimatedCost <= 0)) {
                        alert('Vui lòng nhập năng lượng ước tính để tính chi phí thanh toán.');
                        return;
                    }

                    btnSubmitReservation.disabled = true;
                    btnSubmitReservation.textContent = 'Đang xử lý...';

                    try {
                        var requestBody = {
                            chargingSpotId: spotId,
                            vehicleId: vehicleId,
                            scheduledStartTime: startDate.toISOString(),
                            scheduledEndTime: endDate.toISOString(),
                            estimatedEnergyKwh: energy && energy.trim() !== '' ? parseFloat(energy) : null,
                            estimatedCost: estimatedCost,
                            isPrepaid: paymentMethod === 'vnpay',
                            notes: notes && notes.trim() !== '' ? notes.trim() : null
                        };
                        
                        // Validate parsed values
                        if (requestBody.estimatedEnergyKwh !== null && (isNaN(requestBody.estimatedEnergyKwh) || requestBody.estimatedEnergyKwh < 0)) {
                            requestBody.estimatedEnergyKwh = null;
                        }

                        var response = await fetch('/api/Reservation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify(requestBody)
                        });

                        if (response.ok) {
                            var result = await response.json();
                            bootstrap.Modal.getInstance(document.getElementById('reservationModal')).hide();
                            form.reset();
                            
                            if (paymentMethod === 'vnpay' && result.id && estimatedCost && estimatedCost > 0) {
                                // Redirect to VNPay payment
                                try {
                                    var paymentResponse = await fetch('/api/Payment/vnpay/create', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        credentials: 'include',
                                        body: JSON.stringify({
                                            reservationId: result.id,
                                            amount: estimatedCost,
                                            returnUrl: window.location.origin + '/Driver/Payment/VnPayReturn?reservationId=' + result.id
                                        })
                                    });
                                    
                                    if (paymentResponse.ok) {
                                        var paymentData = await paymentResponse.json();
                                        // Handle both camelCase and PascalCase
                                        var paymentUrl = paymentData.paymentUrl || paymentData.PaymentUrl;
                                        if (paymentUrl) {
                                            window.location.href = paymentUrl;
                                            return;
                                        } else {
                                            console.error('Payment URL not found in response:', paymentData);
                                            alert('Đặt lịch thành công nhưng không thể tạo thanh toán VNPay. Mã xác nhận: ' + result.confirmationCode);
                                        }
                                    } else {
                                        const errorData = await paymentResponse.json().catch(() => ({}));
                                        console.error('Payment creation failed:', errorData);
                                        alert('Đặt lịch thành công nhưng không thể tạo thanh toán VNPay: ' + (errorData.message || 'Lỗi không xác định') + '. Mã xác nhận: ' + result.confirmationCode);
                                    }
                                } catch (paymentErr) {
                                    console.error('Error creating VNPay payment:', paymentErr);
                                    alert('Đặt lịch thành công nhưng không thể tạo thanh toán VNPay. Mã xác nhận: ' + result.confirmationCode);
                                }
                            } else {
                                var message = 'Đặt lịch thành công! Mã xác nhận: ' + (result.confirmationCode || result.id);
                                alert(message);
                            }
                            
                            // Chuyển đến trang đặt chỗ của tôi
                            window.location.href = '/Driver/Reservations';
                        } else {
                            let errorMessage = 'Không thể đặt trước. Vui lòng thử lại.';
                            try {
                                const error = await response.json();
                                if (error.message) {
                                    errorMessage = error.message;
                                } else if (error.errors) {
                                    // Handle validation errors
                                    const errorMessages = [];
                                    for (const key in error.errors) {
                                        if (error.errors[key]) {
                                            errorMessages.push(error.errors[key].join(', '));
                                        }
                                    }
                                    errorMessage = errorMessages.length > 0 ? errorMessages.join('; ') : errorMessage;
                                } else if (typeof error === 'string') {
                                    errorMessage = error;
                                }
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                                errorMessage = `Lỗi ${response.status}: ${response.statusText}`;
                            }
                            alert('Lỗi: ' + errorMessage);
                        }
                    } catch (err) {
                        console.error('Error submitting reservation:', err);
                        alert('Có lỗi xảy ra khi đặt lịch: ' + (err.message || 'Vui lòng thử lại sau.'));
                    } finally {
                        btnSubmitReservation.disabled = false;
                        btnSubmitReservation.textContent = 'Xác nhận đặt lịch';
                    }
                });
            }
        });
    </script>
    <style>
        .custom-marker { background: transparent !important; border: none !important; }
        .leaflet-container { background: #F3F4F6 !important; }
        
        .map-overlay-bar {
            position: absolute;
            bottom: 24px;
            left: 24px;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
            z-index: 10;
        }

        .map-overlay-bar .map-legend {
            position: static;
            margin: 0;
        }

        .btn-current-location-map {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            color: #155DFC;
        }
        
        .btn-current-location-map:hover {
            background: #f8f9fa;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .btn-current-location-map:active {
            transform: scale(0.95);
        }
        
        .btn-current-location-map:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .station-serp-card {
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .station-serp-card:hover {
            border-color: #d1d5db;
            box-shadow: 0px 6px 16px rgba(0, 0, 0, 0.08);
        }

        .station-empty {
            background: #ffffff;
            border: 1px dashed #d1d5db;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #4A5565;
            font-size: 13px;
            line-height: 20px;
        }

        .btn-reserve {
            background: #10B981;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-reserve:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-reserve:active {
            transform: translateY(0);
        }

        .btn-start-charging {
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-start-charging:hover {
            background: #2563EB;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .btn-start-charging:active {
            transform: translateY(0);
        }


        .status-badge.status-full {
            background: #EF4444;
            color: white;
        }

        .status-badge.status-busy {
            background: #F59E0B;
            color: white;
        }

        .status-badge.status-available {
            background: #10B981;
            color: white;
        }
    </style>
}
